<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Gianluca Quercini">

  
  
  
    
  
  <meta name="description" content="Description of the lab structured streaming.">

  
  <link rel="alternate" hreflang="en-us" href="/courses/plp/tutorials/structured-streaming-lab/">

  


  
  
  
  <meta name="theme-color" content="rgb(0, 136, 204)">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  


  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="/courses/plp/tutorials/structured-streaming-lab/">

  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Gianluca Quercini">
  <meta property="og:url" content="/courses/plp/tutorials/structured-streaming-lab/">
  <meta property="og:title" content="Spark structured streaming | Gianluca Quercini">
  <meta property="og:description" content="Description of the lab structured streaming."><meta property="og:image" content="img/map[gravatar:%!s(bool=true) shape:circle]">
  <meta property="twitter:image" content="img/map[gravatar:%!s(bool=true) shape:circle]"><meta property="og:locale" content="en-us">
  
    
    
  

  



  


  


  





  <title>Spark structured streaming | Gianluca Quercini</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#teaching"><span>Teaching</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      

      

      

    </ul>

  </div>
</nav>


  

  

<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      


<script src="/js/toggle-menu.js"></script>







  
    
  




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
</form>

<nav class="collapse docs-links" id="docs-nav">
  

  
  
  
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="overview" class="docs-toc-link" href="/courses/plp/overview/">Overview</a>
    
    <div id="overview-ddowncontent" class="overview-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="overview">
        <a href="/courses/plp/overview/">Big data algorithms, techniques and platforms</a>
      </li>
      
      
      <li class="overview">
        <a href="/courses/plp/overview/installation-mongodb/">Installing MongoDB</a>
      </li>
      
      
      <li class="overview">
        <a href="/courses/plp/overview/cluster-connection/">Connecting to the cluster</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="lectures" class="docs-toc-link" href="/courses/plp/lectures/lectures/">Lectures</a>
    
    <div id="lectures-ddowncontent" class="lectures-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="lectures">
        <a href="/courses/plp/lectures/lectures/">Overview</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="tutorials" class="docs-toc-link" href="/courses/plp/tutorials/cc-tutorials/">Tutorials and labs</a>
    
    <div id="tutorials-ddowncontent" class="tutorials-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="tutorials">
        <a href="/courses/plp/tutorials/cc-tutorials/">Overview</a>
      </li>
      
      
      <li class="tutorials">
        <a href="/courses/plp/tutorials/map-reduce/">MapReduce</a>
      </li>
      
      
      <li class="tutorials">
        <a href="/courses/plp/tutorials/spark-programming-dce/">Introduction to Spark programming</a>
      </li>
      
      
      <li class="tutorials">
        <a href="/courses/plp/tutorials/neo4j-tutorial/">Neo4j</a>
      </li>
      
      
      <li class="tutorials">
        <a href="/courses/plp/tutorials/spark-lab-assignment/">Lab 1. Advanced Spark programming</a>
      </li>
      
      
      <li class="tutorials">
        <a href="/courses/plp/tutorials/mongodb-tutorial/">Lab2. MongoDB Query Language</a>
      </li>
      
      <script>open_menu_on_load("tutorials".concat("-ddowncontent"))</script>
      <li class="active tutorials">
        <a href="/courses/plp/tutorials/structured-streaming-lab/">Lab 3. Spark structured streaming</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="project" class="docs-toc-link" >Project</a>
    

  </div>
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="references" class="docs-toc-link" href="/courses/plp/references/cc-references/">References</a>
    
    <div id="references-ddowncontent" class="references-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="references">
        <a href="/courses/plp/references/cc-references/">Bibliography</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  
</nav>

    </div>

    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          <div class="heading">Big data algorithms, techniques and platforms — Lab assignment 3</div>
          <h1>Spark structured streaming</h1>
          <hr>
          <div class="logo">
            <p><img src="/img/cs-logo.png" width="20%" style="display: block; margin: auto;" /></p>
            </div>

          <div class="article-style">
            


<p><link rel="stylesheet" href="/styles/course.css">
<link rel="stylesheet" href="/styles/cloud-computing.css"></p>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>The goal of this lab assignment is to learn how to analyze streams of data with the Spark Structured Streaming API.
<a href="/courses/plp/overview/cluster-connection" target="_blank">Refer to this documentation</a> to learn how to connect and
interact with the cluster.</p>
<div class="infobox warning">
<p><strong>Documentation</strong></p>
<p>In order to answer the questions and do the exercises, you might want to refer to the following
documentation:</p>
<ul>
<li><p>The <a href="https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html" target="_blank">Structured Streaming programing guide</a>.</p></li>
<li><p>The <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql.html" target="_blank">Spark SQL API reference</a>.</p></li>
</ul>
</div>
<!-- ############ IMPORTANT: CHANGE THESE VALUES BEFORE ANY LAB ############ -->
<!-- The group to which users in the cluster belong-->
<!-- User accounts are numbered from the lower to the upper limit-->
<!-- ############ END OF MODIFICATIONS ############ -->
</div>
<div id="warming-up" class="section level1">
<h1>Warming up</h1>
<p>Consider the following program.</p>
<pre><code>from pyspark.sql import SparkSession
from pyspark.sql.types import *
import pyspark.sql.functions as F

port_number = COMPLETE HERE
checkpoint_location = COMPLETE HERE

spark = (SparkSession.builder.appName(&quot;Structured Streaming - exo1&quot;).getOrCreate())

lines = (spark\
        .readStream.format(&quot;socket&quot;)\
        .option(&quot;host&quot;, &quot;localhost&quot;)\
        .option(&quot;port&quot;, port_number)\
        .load())

streamingQuery = lines.writeStream\
                .option(&quot;checkpointLocation&quot;, checkpoint_location)\
                .format(&quot;console&quot;).start()

streamingQuery.awaitTermination()</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-1" class="exercise"><strong>Exercise 1  </strong></span></p>
<ol style="list-style-type: decimal">
<li><p>Where does this program get its input?</p></li>
<li><p>What object type does the variable <code>lines</code> contain?</p></li>
<li><p>Where does this program write its output?</p></li>
<li><p>What is the output of this program?</p></li>
<li><p>What is the option <code>checkpointLocation</code> intended for?</p></li>
<li><p>What does the instruction <code>streamingQuery.awaitTermination()</code>?</p></li>
</ol>
</div>
</div>
<p>You can now verify your answers to the previous questions by <strong>executing the program</strong>.</p>
<div class="infobox activitybox">
<p><strong>Activity</strong></p>
<ol style="list-style-type: decimal">
<li><p>Connect to the cluster, if you haven’t done so yet. <a href="/courses/plp/overview/cluster-connection" target="_blank">Refer to this documentation</a>.</p></li>
<li><p>After running the command <code>srun ...</code>, you should be connected to a machine on the cluster Kyle.
Note the name of this machine (you should see it at the terminal prompt).</p></li>
<li><p>Create a checkpoint directory for the first exercise (e.g., <code>checkpoint_exo1</code>) under your home directory
<code>hdfs://sar01:9000/cpuasi1/cpuasi1_X</code> <strong>in HDFS</strong>.</p></li>
<li>Copy and paste the code into a Python file (e.g., <code>exo1.py</code>) that you’ll save into your home directory <strong>in the local filesystem</strong>
of the cluster machine.
<ul>
<li>Change the value of the variable <code>checkpoint_location</code> so that it points to the directory that you created at point 3.</li>
<li>Change the value of the variable <code>port_number</code> to any value in the range [49152, 65535].</li>
</ul></li>
</ol>
<ul>
<li><p>Open a new terminal window, connect to <code>phome.metz.supelec.fr</code> and then to the same machine that you noted at point 2.</p></li>
<li><p>In the new terminal, start a <strong>netcat server</strong> listening on the port number that you selected at point 4. Use the following command:</p></li>
</ul>
<p><code>nc -lk port_number</code></p>
<ol start="5" style="list-style-type: decimal">
<li>Run the Python code with the command <code>spark-submit</code>. Wait until Spark does not display any more messages on screen.
<ul>
<li>In case the program stops for an error, read the box “What to do in case of errors” below.</li>
</ul></li>
<li>In the netcat terminal, write few lines of text. Look at the terminal where the Spark program is running and observe the output.</li>
</ol>
</div>
<div class="infobox warning">
<p><strong>What to do in case of errors</strong></p>
<p>If any error arises, <strong>before</strong> running the <code>spark-submit</code> again it would be better to remove
all files from the checkpoint directory.</p>
</div>
<div class="infobox warning">
<p><strong>Stop the program</strong></p>
<ul>
<li><p>When you’re done with your experiments, you can stop the Spark program by simply
typing CTRL-C in the terminal where Spark is running.</p></li>
<li><p>Don’t stop the netcat server, you’ll need it in the next exercise.</p></li>
</ul>
</div>
</div>
<div id="triggering-policy" class="section level1">
<h1>Triggering policy</h1>
<p>In a Structured Streaming program we can choose a <strong>triggering policy</strong>.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-2" class="exercise"><strong>Exercise 2  </strong></span></p>
<ol style="list-style-type: decimal">
<li><p>What is a triggering policy?</p></li>
<li><p>What is the triggering policy in the previous program?</p></li>
<li><p>Modify the code of the previous program in order to set the
<code>Fixed interval micro-batch</code> triggering policy.</p></li>
<li><p>Run the program. How is the behaviour of this program different from before?</p></li>
</ol>
</div>
</div>
</div>
<div id="checkpoint-location-and-output-mode" class="section level1">
<h1>Checkpoint location and output mode</h1>
<p>We’re now going to see the impact of the checkpoint location and the output modes on a streaming query.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-3" class="exercise"><strong>Exercise 3  </strong></span></p>
<ol style="list-style-type: decimal">
<li><p>What is an output mode and what are the available options?</p></li>
<li>What is the output mode of the previous program?</li>
</ol>
</div>
</div>
<p>We’re now going to write a new streaming query.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-4" class="exercise"><strong>Exercise 4  </strong></span></p>
<ol style="list-style-type: decimal">
<li><p>Create a new checkpoint location in HDFS.
You may also keep the same as before; in this case, make sure you <strong>remove</strong> all files from that
directory.</p></li>
<li><p>Write a new program that reads a streaming text from a TCP socket and
counts the number of occurrences of each word.</p></li>
<li><p>Which output mode are you going to choose and why?</p></li>
<li><p>Run the program. Write few lines on the netcat server and observe the output.</p></li>
<li><p>Stop the program and rerun it again with no modifications. Write few lines in the netcat terminal and observe the output.
What can you say about the word counts?</p></li>
<li><p>Stop the program and remove the files in the checkpoint location. Rerun again the program and write few lines
on the netcat terminal. What can you say about the word counts?</p></li>
<li><p>Play with the different output modes and observe how the output changes.</p></li>
</ol>
</div>
</div>
</div>

          </div>

          



          
        </div>

        
      </article>

      

    </main>
  </div>
</div>


      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academic.min.6f7ce8be710290b8c431bbc97f405d15.js"></script>

    






  
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
