<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Gianluca Quercini">

  
  
  
    
  
  <meta name="description" content="5. Spark MLlib">

  
  <link rel="alternate" hreflang="en-us" href="/courses/bigdata-mds/labs/spark-mllib/">

  


  
  
  
  <meta name="theme-color" content="rgb(0, 136, 204)">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  


  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_32x32_fill_lanczos_center_3.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_192x192_fill_lanczos_center_3.png">

  <link rel="canonical" href="/courses/bigdata-mds/labs/spark-mllib/">

  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Gianluca Quercini">
  <meta property="og:url" content="/courses/bigdata-mds/labs/spark-mllib/">
  <meta property="og:title" content="Spark MLlib | Gianluca Quercini">
  <meta property="og:description" content="5. Spark MLlib"><meta property="og:image" content="img/map[gravatar:%!s(bool=true) shape:circle]">
  <meta property="twitter:image" content="img/map[gravatar:%!s(bool=true) shape:circle]"><meta property="og:locale" content="en-us">
  
    
    
  

  



  


  


  





  <title>Spark MLlib | Gianluca Quercini</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#teaching"><span>Teaching</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      

      

      

    </ul>

  </div>
</nav>


  

  

<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      


<script src="/js/toggle-menu.js"></script>







  
    
  




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
</form>

<nav class="collapse docs-links" id="docs-nav">
  

  
  
  
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="labs" class="docs-toc-link" href="/courses/bigdata-mds/labs/map-reduce/">Labs</a>
    
    <div id="labs-ddowncontent" class="labs-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="labs">
        <a href="/courses/bigdata-mds/labs/map-reduce/">1. MapReduce</a>
      </li>
      
      
      <li class="labs">
        <a href="/courses/bigdata-mds/labs/first-spark-program/">2. DCE - Premier programme Spark</a>
      </li>
      
      
      <li class="labs">
        <a href="/courses/bigdata-mds/labs/spark-rdd/">3. Programmes Spark sur DCE</a>
      </li>
      
      
      <li class="labs">
        <a href="/courses/bigdata-mds/labs/spark-sql/">4. Spark Structured API</a>
      </li>
      
      <script>open_menu_on_load("labs".concat("-ddowncontent"))</script>
      <li class="active labs">
        <a href="/courses/bigdata-mds/labs/spark-mllib/">5. Spark MLlib</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="documentation" class="docs-toc-link" >Documentation</a>
    

  </div>
  
  
</nav>

    </div>

    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          <div class="heading">Big Data MDS â€” Lab 5</div>
          <h1>Spark MLlib</h1>
          <hr>
          <div class="logo">
            
            </div>

          <div class="article-style">
            
<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p><link rel="stylesheet" href="/styles/course.css">
<link rel="stylesheet" href="/styles/cloud-computing.css"></p>
<!-- ############ IMPORTANT: CHANGE THESE VALUES BEFORE ANY LAB ############ -->
<!-- The group to which users in the cluster belong-->
<!-- User accounts are numbered from the lower to the upper limit-->
<!-- ############ END OF MODIFICATIONS ############ -->
<p>Dans ce TD, vous apprendrez Ã  utiliser la bibliothÃ¨que <strong>Spark MLlib</strong> pour entraÃ®ner, tester et Ã©valuer des modÃ¨les dâ€™apprentissage automatique.
Nous utiliserons un jeu de donnÃ©es sur les logements AirBnb dans la rÃ©gion de San Francisco.
Le jeu de donnÃ©es est disponible sur HDFS au chemin suivant :</p>
<div align="center">
<p><code>hdfs://sar01:9000/prof/cpu_quercini/ml/sf-airbnb-clean.parquet</code></p>
</div>
<div class="infobox warning">
<p><strong>Source du jeu de donnÃ©es</strong></p>
<p>Le jeu de donnÃ©es a Ã©tÃ© tÃ©lÃ©chargÃ© Ã  partir <a href="https://github.com/databricks/LearningSparkV2" target="_blank">de ce dÃ©pÃ´t GitHub</a>.</p>
</div>
<p>Le but de ce TD est de prÃ©dire le prix par nuit dâ€™un appartement en fonction de toutes les caractÃ©ristiques des donnÃ©es.</p>
<div class="infobox warning">
<p><strong>Bon Ã  savoir.</strong></p>
<p>Lâ€™interprÃ©teur Python utilisÃ© par les exÃ©cuteurs du cluster nâ€™a pas le paquet <code>numpy</code> installÃ©.
Afin dâ€™utiliser un interprÃ©teur qui utilise <code>numpy</code>, vous devez exÃ©cuter la commande suivante dans le terminal :</p>
<div align="center">
<pre><code>export PYSPARK_PYTHON=/usr/bin/python3</code></pre>
</div>
</div>
<div id="ensemble-dentraÃ®nement-et-ensemble-de-test" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Ensemble dâ€™entraÃ®nement et ensemble de test</h1>
<p>Afin de entraÃ®ner et dâ€™Ã©valuer un modÃ¨le dâ€™apprentissage automatique, nous devons
obtenir un <strong>ensemble dâ€™entraÃ®nement</strong> et un <strong>ensemble de test</strong> Ã  partir de notre jeu de donnÃ©es.</p>
<div class="infobox exercisebox">
<p><strong>ActivitÃ©</strong></p>
<ol style="list-style-type: decimal">
<li>Copiez le fichier <code>train_test.py</code> vers votre dossier personnel (sur les machines du DCE) Ã  lâ€™aide de la commande suivante :</li>
</ol>
<div align="center">
<pre><code>cp ~cpu_quercini/mllib/train_test.py .</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li><strong>ComplÃ©tez la ligne 9</strong>, en spÃ©cifiant votre rÃ©pertoire personnel sur HDFS, qui est le suivant (<strong>remplacer X par votre numÃ©ro de compte</strong>).</li>
</ol>
<div align="center">
<p><code>hdfs://sar01:9000/itpspark24/itpspark24_X</code></p>
</div>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-1" class="exercise"><strong>Exercise 1.1  </strong></span></p>
<ol style="list-style-type: decimal">
<li><p><strong>Ã‰crivez le code</strong> pour lire le fichier donnÃ©, qui est stockÃ© sur HDFS au format Parquet, et charger son contenu dans un DataFrame nommÃ© <code>airbnb_df</code>.</p></li>
<li><p><strong>Ã€ partir de la ligne 26</strong>, ajoutez les instructions nÃ©cessaires pour afficher le schÃ©ma du DataFrame <code>airbnb_df</code> et les 5 premiÃ¨res lignes.
Quelle option devriez-vous utiliser pour voir les valeurs dans les colonnes ?</p></li>
<li><p>ExÃ©cutez le code Ã  lâ€™aide de la commande <code>spark-submit</code>, et vÃ©rifiez que les donnÃ©es sont correctement chargÃ©es dans le DataFrame.</p></li>
</ol>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier :</p>
<pre><code>
~cpu_quercini/mllib_solutions/train_test.py
</code></pre>
<p>Puisque le DataFrame a beaucoup de colonnes, nous avons besoin de spÃ©cifier lâ€™option <code>vertical=True</code> lorsquâ€™on appelle la fonction <code>show()</code>.</p>
</div>
</details>
<p>Nous sÃ©parons maintenant le DataFrame <code>airbnb_df</code> en deux DataFrames distincts, <code>train_df</code> et <code>test_df</code>,
contenant respectivement les instances dâ€™entraÃ®nement et de test.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-2" class="exercise"><strong>Exercise 1.2  </strong></span></p>
<ol style="list-style-type: decimal">
<li><p><strong>Ã‰crivez le code</strong> pour diviser le jeu de donnÃ©es en un ensemble dâ€™entraÃ®nement (80% du jeu de donnÃ©es) et un ensemble de test (20% du jeu de donnÃ©es).
<a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.html" target="_blank">En consultant la documentation de lâ€™API DataFrame</a>, quelle fonction allez-vous utiliser ?</p></li>
<li><p><strong>A partir de la ligne 36</strong>, Ã©crivez le code pour afficher le nombre dâ€™instances des deux ensembles obtenus.</p></li>
<li><p>ExÃ©cutez le code Ã  lâ€™aide de la commande <code>spark-submit</code>. VÃ©rifiez que le nombre dâ€™instances des deux ensembles soit correct.</p></li>
</ol>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>
~cpu_quercini/mllib_solutions/train_test.py
</code></pre>
</div>
</details>
<p>Il est temps dâ€™enregistrer les ensembles dâ€™entraÃ®nement et de test dans deux fichiers HDFS sÃ©parÃ©s.
Ainsi, nous pourrons les charger chaque fois que nous en aurons besoin pour entraÃ®ner un modÃ¨le dâ€™apprentissage automatique
pour ce problÃ¨me.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-3" class="exercise"><strong>Exercise 1.3  </strong></span></p>
<p><strong>Ã€ partir de la ligne 47</strong>. Ecrivez le code pour sauvegarder les ensembles dâ€™entraÃ®nement et de test dans deux fichiers au format Parquet sur HDFS.
Les chemins dâ€™accÃ¨s des deux fichiers sont dÃ©jÃ  disponibles dans les variables <code>training_set_file</code> et <code>test_set_file</code>
dÃ©finies respectivement aux lignes 40 et 43.</p>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>
~cpu_quercini/mllib_solutions/train_test.py
</code></pre>
</div>
</details>
</div>
<div id="prÃ©paration-des-caractÃ©ristiques" class="section level1" number="2">
<h1><span class="header-section-number">2</span> PrÃ©paration des caractÃ©ristiques</h1>
<p>Dans les ensembles dâ€™entraÃ®nement et de test, les caractÃ©ristiques des donnÃ©es correspondent aux colonnes du DataFrame.
La plupart des algorithmes dâ€™apprentissage automatique dÃ©finis dans Spark ont besoin dâ€™avoir toutes les caractÃ©ristiques dans un seul vecteur.
Nous devons utiliser un <strong>transformateur</strong>.</p>
<div class="infobox warning">
<p><strong>Bon Ã  savoir.</strong></p>
<p><strong>Les transformateurs</strong> prennent en argument un DataFrame et renvoient un nouveau DataFrame
qui a les mÃªmes colonnes que le DataFrame en argument et des colonnes supplÃ©mentaires spÃ©cifiÃ©es en tant quâ€™argument du transformateur.</p>
</div>
</div>
<p>Copiez le fichier <code>train_test_model</code> vers votre dossier personnel (sur les machines du DCE) Ã  lâ€™aide de la commande suivante :</p>
<div align="center">
<p>cp ~cpu_quercini/mllib/train_test_model.py .</p>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-4" class="exercise"><strong>Exercise 2.1  </strong></span></p>
<ul>
<li><p>ImplÃ©mentez la fonction <code>read_training_set</code> Ã  la ligne 22.
Cette fonction charge dans un DataFrame lâ€™ensemble dâ€™entraÃ®nement Ã  partir du fichier que vous avez gÃ©nÃ©rÃ© Ã  lâ€™exercice prÃ©cÃ©dent.</p></li>
<li><p>ImplÃ©mentez la fonction <code>read_test_function</code> Ã  la ligne 39.
Cette fonction charge dans un DataFrame lâ€™ensemble de test Ã  partir du fichier que vous avez gÃ©nÃ©rÃ© Ã  lâ€™exercice prÃ©cÃ©dent.</p></li>
<li><p>Modifiez les variables aux lignes 105 et 106 pour quâ€™elles pointent vers les deux fichiers HDFS Parquet qui contiennent les ensembles dâ€™entraÃ®nement et de test.</p></li>
<li><p>DÃ©commentez les lignes 109 et 110, afin dâ€™afficher le nombre dâ€™instances dâ€™entraÃ®nement et de test.</p></li>
<li><p>ExÃ©cutez le fichier <code>train_test_model</code> Ã  lâ€™aide de la commande <code>spark-submit</code>. VÃ©rifiez que le nombre dâ€™instances dâ€™entraÃ®nement et de test corresponde
Ã  ce que vous avez obtenu lors des exercices prÃ©cÃ©dents.</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier :</p>
<pre><code>
~cpu_quercini/mllib_solutions/train_test_model.py
</code></pre>
</div>
</details>
<p>Il est maintenant temps dâ€™apprendre Ã  utiliser un transformateur pour mettre toutes les caractÃ©ristiques nÃ©cessaires dans un vecteur.
Pour lâ€™instant, nous nâ€™utiliserons que la caractÃ©ristique Â« bedrooms Â» pour prÃ©dire le prix.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-5" class="exercise"><strong>Exercise 2.2  </strong></span></p>
<ul>
<li><p>ImplÃ©mentez la fonction <code>get_vector</code> Ã  la ligne 55. Les commentaires dans le fichier dÃ©crivent ce que la fonction doit faire.
Vous devrez utiliser un <a href="https://spark.apache.org/docs/latest/api/python/reference/api/pyspark.ml.feature.VectorAssembler.html#pyspark.ml.feature.VectorAssembler" target="_blank">objet VectorAssembler</a> pour implÃ©menter la fonction.</p></li>
<li><p>DÃ©commentez les lignes 117 et 118 pour appeler la fonction <code>get_vector</code> et afficher le rÃ©sultat.</p></li>
<li><p>ExÃ©cutez le fichier <code>train_test_model</code> Ã  lâ€™aide de la commande <code>spark-submit</code>. Observez le contenu du DataFrame <code>train_vect</code>. Il devrait avoir une colonne nommÃ©e
<code>features</code> contenant une liste avec une valeur (la valeur de la caractÃ©ristique <code>bedrooms</code>).</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>
~cpu_quercini/mllib_solutions/train_test_model.py
</code></pre>
</div>
</details>
<p>Il est maintenant temps dâ€™entraÃ®ner un modÃ¨le de rÃ©gression linÃ©aire sur lâ€™ensemble dâ€™entraÃ®nement donnÃ© et les caractÃ©ristiques sÃ©lectionnÃ©es.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-6" class="exercise"><strong>Exercise 2.3  </strong></span></p>
<ul>
<li><p>ImplÃ©mentez la fonction <code>train_linear_regression_model</code> Ã  la ligne 79. Les commentaires du fichier dÃ©crivent ce que la fonction est censÃ©e faire.
<a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.ml.html" target="_blank">En consultant la documentation</a>,
essayez dâ€™identifier lâ€™objet que vous devez utiliser pour crÃ©er un rÃ©gresseur linÃ©aire et la fonction que vous devez utiliser pour lâ€™entraÃ®ner.</p></li>
<li><p>DÃ©commentez les lignes 121, 124, 125, 126 pour appeler la fonction <code>train_linear_regression_model</code> et afficher les coefficients appris par le modÃ¨le de rÃ©gression linÃ©aire.</p></li>
<li><p>ExÃ©cutez le fichier <code>train_test_model</code> Ã  lâ€™aide de la commande <code>spark-submit</code>.</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier :</p>
<pre><code>
~cpu_quercini/mllib_solutions/train_test_model.py
</code></pre>
</div>
</details>
<p>Nous pouvons maintenant utiliser le modÃ¨le entraÃ®nÃ© pour faire des prÃ©dictions.
Le modÃ¨le renovyÃ© par la fonction que vous avez implÃ©mentÃ©e dans lâ€™exercice prÃ©cÃ©dent
est un objet de type <code>LinearRegressionModel</code>.
<a href="https://spark.apache.org/docs/latest/api/python/reference/api/pyspark.ml.regression.LinearRegressionModel.html#pyspark.ml.regression.LinearRegressionModel" target="_blank_">En consultant la documentation</a>, nous apprenons quâ€™il existe une fonction <code>predict</code>
permettant de faire une prÃ©diction Ã  partir dâ€™une seule instance.
Si nous voulons faire une prÃ©diction sur lâ€™ensemble du jeu de test, nous devons utiliser la fonction <code>transform</code>.
La fonction prend en argument un DataFrame avec lâ€™ensemble de test et renvoie le mÃªme DataFrame
avec une colonne supplÃ©mentaire <code>prediction</code> qui contient la valeur prÃ©dite.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-7" class="exercise"><strong>Exercise 2.4  </strong></span></p>
<ul>
<li><p>Regardez les lignes 130 et 131. Quel DataFrame devons-nous passer Ã  la fonction <code>transform</code> ? Est-ce que <code>test_df</code> est un bon choix ? Pourquoi ?</p></li>
<li><p>ComplÃ©tez la ligne 130 et dÃ©commentez les lignes 130, 131, 132.</p></li>
<li><p>ExÃ©cutez le fichier <code>train_test_model</code> Ã  lâ€™aide de la commande <code>spark-submit</code> et observez le rÃ©sultat.
La valeur prÃ©dite est-elle celle Ã  laquelle vous vous attendez Ã©tant donnÃ© que vous connaissez la formule de la droite de rÃ©gression ?</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p><code>test_df</code> nâ€™est pas un bon choix.
En fait, le DataFrame de lâ€™ensemble de test doit avoir le mÃªme format que le DataFrame de lâ€™ensemble dâ€™apprentissage
sur lequel le modÃ¨le a Ã©tÃ© entraÃ®nÃ©.</p>
<p>Donc, nous devons le transformer avec un objet <code>vecAssembler</code>.</p>
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>
~cpu_quercini/mllib_solutions/train_test_model.py
</code></pre>
</div>
</details>
</div>
<div id="pipelines" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Pipelines</h1>
<p>Dans la section prÃ©cÃ©dente, nous avons appris quâ€™un ensemble dâ€™entraÃ®nement et un ensemble
de test doivent passer par les mÃªmes Ã©tapes de transformation afin dâ€™alimenter un modÃ¨le dâ€™apprentissage automatique.</p>
<p>Lorsque nous avons peu de transformations, il est facile de se souvenir de
celles que nous avons appliquÃ©es Ã  un ensemble dâ€™entraÃ®nement, afin de les appliquer Ã©galement Ã  lâ€™ensemble de test.</p>
<p>Cependant, lorsque nous devons appliquer une sÃ©rie de transformations, dont lâ€™ordre est important,
il est facile de commettre des erreurs.</p>
<p>Une bonne pratique consiste Ã  utiliser lâ€™API <strong>Pipeline</strong>.</p>
<p>Un <strong>pipeline</strong> est composÃ©e dâ€™<strong>Ã©tapes</strong>. Chaque Ã©tape peut consister de lâ€™appel Ã  un <strong>transformateur</strong> ou Ã  un <strong>estimateur</strong>.</p>
<ul>
<li>Un <strong>transformateur</strong> est un objet sur lequel nous appelons la fonction <code>transform</code> pour obtenir un nouveau DataFrame Ã  partir dâ€™un DataFrame donnÃ©.</li>
<li>Un <strong>estimateur</strong> est un objet sur lequel nous appelons la fonction <code>fit</code> pour apprendre un modÃ¨le sur un DataFrame donnÃ©. Le modÃ¨le appris est lui-mÃªme
un transformateur.</li>
</ul>
<p>Lorsque la fonction <code>fit</code> est appelÃ©e sur un pipeline, lâ€™ensemble dâ€™apprentissage passe par tous
les transformateurs et les estimateurs dans lâ€™ordre dans lequel ils sont dÃ©clarÃ©s dans le pipeline ;
enfin, lâ€™estimateur spÃ©cifiÃ© Ã  la derniÃ¨re Ã©tape est entraÃ®nÃ© sur lâ€™ensemble dâ€™apprentissage.
Le modÃ¨le renovyÃ© par lâ€™application de la fonction <code>fit</code> sur le pipeline est lui-mÃªme un transformateur.
Si nous invoquons la fonction <code>transform</code> sur ce modÃ¨le sur lâ€™ensemble de test, nous obtenons un DataFrame qui contient une colonne nommÃ©e <code>predictions</code>.
Implicitement, toutes les transformations dans le pipeline seront appliquÃ©es Ã  lâ€™ensemble de test aussi, avant de faire les prÃ©dictions.</p>
<p>Copiez le fichier <code>pipeline_example.py</code> dans votre dossier personnel Ã  lâ€™aide de la commande suivante :</p>
<div align="center">
<pre><code>cp ~cpu_quercini/mllib/pipeline_example.py .</code></pre>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-8" class="exercise"><strong>Exercise 3.1  </strong></span>
<a href="https://spark.apache.org/docs/latest/ml-pipeline.html" target="_blank">Regardez la documentation</a> et
Ã©crivez un code Ã  partir de la ligne 34 pour crÃ©er un pipeline qui effectue les mÃªmes opÃ©rations que vous avez Ã©crites dans le fichier <code>train_test_model.py</code>
pour entraÃ®ner et tester un modÃ¨le de rÃ©gression linÃ©aire sur les ensembles dâ€™entraÃ®nement et de test donnÃ©s.</p>
<ul>
<li>Nâ€™oubliez pas de spÃ©cifier <strong>aux lignes 27 et 28</strong> les chemins dâ€™accÃ¨s des fichiers dâ€™entraÃ®nement et de test stockÃ©s sur HDFS .</li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>~cpu_quercini/mllib_solutions/pipeline_example.py</code></pre>
</div>
</details>
<div id="des-caractÃ©ristiques-catÃ©gorielles-aux-caractÃ©ristiques-numÃ©riques" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Des caractÃ©ristiques catÃ©gorielles aux caractÃ©ristiques numÃ©riques</h2>
<p>De nombreux modÃ¨les dâ€™apprentissage automatique nâ€™acceptent pas des valeurs catÃ©gorielles : ils ont besoin que toutes les caractÃ©ristiques soient numÃ©riques.
La rÃ©gression linÃ©aire en est un exemple.</p>
<div class="infobox activitybox">
<p><strong>ActivitÃ©</strong></p>
<ul>
<li>Copiez le fichier <code>onehot_playground.py</code> vers votre dossier personnel Ã  lâ€™aide de la commande suivante :</li>
</ul>
<div align="center">
<pre><code>cp ~cpu_quercini/mllib/onehot_playground.py .</code></pre>
</div>
<ul>
<li>Modifiez les lignes 27 et 28 et Ã©crivez les chemins dâ€™accÃ¨s des fichiers contenant les ensembles dâ€™entraÃ®nement et de test.</li>
</ul>
</div>
<p>CommenÃ§ons par dÃ©terminer quelles sont les caractÃ©ristiques catÃ©gorielles de notre jeu de donnÃ©es.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-9" class="exercise"><strong>Exercise 3.2  </strong></span>
ComplÃ©tez la fonction <code>get_categorical_columns</code>.</p>
<ul>
<li><p>Pour avoir une idÃ©e sur comment obtenir les colonnes catÃ©gorielles, exÃ©cutez le code Ã  lâ€™aide de la commande <code>spark_submit</code>.
Ceci exÃ©cute lâ€™instruction Ã  la ligne 86.</p></li>
<li><p>Une fois que vous avez terminÃ© lâ€™implÃ©mentation, exÃ©cutez le fichier Ã  lâ€™aide de la commande <code>spark-submit</code> et observez la sortie.</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>~cpu_quercini/mllib_solutions/onehot_playground.py</code></pre>
</div>
</details>
<p>Un exemple de caractÃ©ristique catÃ©gorielle
dans notre jeu de donnÃ©es est <code>property_type</code>,
qui accepte des valeurs telles que <em>Apartment</em>, <em>House</em>, <em>Condominium</em>â€¦
Chaque valeur dâ€™une caractÃ©ristique catÃ©gorielle est Ã©galement appelÃ©e catÃ©gorie.</p>
<p>Une faÃ§on de transformer cette caractÃ©ristique en une caractÃ©ristique
numÃ©rique serait dâ€™attribuer un numÃ©ro Ã  chaque catÃ©gorie
(par exemple, <em>Appartement</em> correspond Ã  0, <em>Maison</em> Ã  1â€¦.).
Cependant, cela introduit implicitement un ordre entre les catÃ©gories : la catÃ©gorie <em>Maison</em> vaudrait deux fois plus que la catÃ©gorie <em>Appartement</em> ;
Cela fausserait inÃ©vitablement le modÃ¨le.</p>
<p>Une mÃ©thode couramment utilisÃ©e est lâ€™encodage <strong>one-hot</strong>. Voyons comment elle fonctionne.
Concentrons-nous uniquement sur la caractÃ©ristique <code>type_de_propriÃ©tÃ©</code>.</p>
<div class="infobox activitybox">
<p><strong>ActivitÃ©</strong></p>
<ul>
<li><p>DÃ©commentez les lignes 40, 41 et 42. Ces lignes instancient un estimateur appelÃ© <code>StringIndexer</code>.
Cet estimateur associe des index numÃ©riques aux valeurs de <code>property_type</code>. Les index seront stockÃ©s dans une autre colonne
nommÃ©e <code>property_type_index</code>.</p></li>
<li><p>DÃ©commentez la ligne 46. Le <code>StringIndexer</code> est appliquÃ© Ã  lâ€™ensemble dâ€™entraÃ®nement pour apprendre Ã  associer des index aux valeurs de
<code>property_type</code>. Le rÃ©sultat de cette instruction est un nouveau transformateur.</p></li>
<li><p>DÃ©commentez la ligne 49. Le transformateur appris Ã  la ligne 46 est utilisÃ© pour transformer lâ€™ensemble dâ€™entraÃ®nement dans un nouveau DataFrame.
Ce DataFrame contient une colonne supplÃ©mentaire appelÃ©e <code>property_type_index</code>.</p></li>
</ul>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-10" class="exercise"><strong>Exercise 3.3  </strong></span>
ComplÃ©tez la fonction <code>count_property_types</code>.
Suivez les instructions que vous trouvez dans le fichier <code>onehot_playground.py</code>.</p>
<ul>
<li><p>Une fois la fonction terminÃ©e, dÃ©commentez la ligne 53 pour appeler la fonction.</p></li>
<li><p>ExÃ©cutez le fichier Ã  lâ€™aide de la commande <code>spark-submit</code> et observez la sortie. Pouvez-vous deviner comment les index sont assignÃ©s aux catÃ©gories
de lâ€™Ã©lÃ©ment <code>property_type</code> ?</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>~cpu_quercini/mllib_solutions/onehot_playground.py</code></pre>
<p>On constate que le type de propriÃ©tÃ© le plus frÃ©quent obtient lâ€™indice 0 ; le deuxiÃ¨me plus frÃ©quent obtiendra la valeur 1â€¦les indices sont donc attribuÃ©s par frÃ©quence.
Chaque fois que nous exÃ©cutons le mÃªme code, nous obtenons les mÃªmes index.
Cela signifie que nous avons un dÃ©terminisme sur les diffÃ©rentes exÃ©cutions dâ€™un mÃªme programme.</p>
</div>
</details>
<p>Il est temps de dÃ©couvrir comment fonctionne lâ€™encodage one-hot.</p>
<div class="infobox activitybox">
<p><strong>ActivitÃ©</strong></p>
<ul>
<li><p>DÃ©commentez les lignes 57, 58, 61, 64, 67. Ces lignes instancient un estimateur appelÃ© <code>OneHotEncoder</code>.
Cet estimateur utilise les index de la colonne <code>property_type_index</code> et crÃ©e une nouvelle colonne <code>property_type_ohe</code>.</p></li>
<li><p>Lâ€™estimateur est entraÃ®nÃ© sur lâ€™ensemble dâ€™entraÃ®nement et un nouveau transformateur est obtenu (ligne 61).</p></li>
<li><p>Le transformateur est utilisÃ© sur lâ€™ensemble dâ€™entraÃ®nement pour le transformer en un nouveau DataFrame, qui aura une nouvelle colonne <code>property_type_ohe</code> .</p></li>
<li><p>La ligne 67 affiche des colonnes sÃ©lectionnÃ©es de cet ensemble dâ€™entraÃ®nement transformÃ©.</p></li>
</ul>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-11" class="exercise"><strong>Exercise 3.4  </strong></span></p>
<ul>
<li><p>ExÃ©cutez le fichier Ã  lâ€™aide de la commande <code>spark-submit</code>.</p></li>
<li><p>Pouvez-vous comprendre comment fonctionne lâ€™encodage one-hot ?</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>~cpu_quercini/mllib_solutions/onehot_playground.py</code></pre>
<p>Lâ€™encodage one-hot crÃ©e un vecteur avec autant de valeurs que le nombre de catÃ©gories dans la colonne
<code>property_type</code>.
Chaque catÃ©gorie a un index fixe dans ce vecteur, donnÃ© par la colonne <code>property_type_index</code>.
Si, pour une instance, la valeur de la colonne <code>property_type</code> est <em>Guest suite</em> et que lâ€™index de <em>Guest suite</em> est 3,
alors le vecteur produit par lâ€™encodage one-hot nâ€™a quâ€™une valeur 1 Ã  lâ€™index 3 et 0 partout ailleurs.
Spark ne stocke quâ€™une reprÃ©sentation concise de ce vecteur creux : un tuple avec la taille du vecteur,
lâ€™index 3 et la valeur associÃ©e Ã  cet index (1).</p>
</div>
</details>
<p>Maintenant, vous avez tous les ingrÃ©dients pour crÃ©er un pipeline complet
pour former et tester un modÃ¨le de rÃ©gression linÃ©aire en utilisant toutes les fonctionnalitÃ©s.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-12" class="exercise"><strong>Exercise 3.5  </strong></span>
CrÃ©ez un nouveau fichier <code>full_pipeline.py</code> et suivez ces instructions :</p>
<ul>
<li><p>SÃ©lectionnez les caractÃ©ristiques catÃ©gorielles.</p></li>
<li><p>Configurez un <code>StringIndexer</code> et un <code>OneHotEncoder</code> pour appliquer un encodage one-hot Ã  toutes les caractÃ©ristiques catÃ©gorielles.</p></li>
<li><p>Extrayez les caractÃ©ristiques numÃ©riques.</p></li>
<li><p>Mettez en oeuvre un <code>VectorAssembler</code> pour mettre dans un seul vecteur les caractÃ©ristiques encodÃ©es et les caractÃ©ristiques numÃ©riques.</p></li>
<li><p>Mettez en oeuvre un modÃ¨le de rÃ©gression linÃ©aire qui prend en arguments toutes les caractÃ©ristiques et la variable Ã  prÃ©dire (<code>price</code>).</p></li>
<li><p>MÃ©langez tous ces ingrÃ©dients dans un <code>Pipeline</code>.</p></li>
<li><p>Utilisez le <code>Pipeline</code> pour entraÃ®ner et tester le modÃ¨le.</p></li>
</ul>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>~cpu_quercini/mllib_solutions/full_pipeline.py</code></pre>
</div>
</details>
</div>
</div>
<div id="Ã©valuation-du-modÃ¨le" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Ã‰valuation du modÃ¨le</h1>
<p>Dans les sections prÃ©cÃ©dentes, nous avons examinÃ© les prÃ©dictions pour avoir une vague idÃ©e des performances de notre
estimateur.
Afin de quantifier la qualitÃ© de notre estimateur, nous avons besoin de mesures dâ€™Ã©valuation.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-13" class="exercise"><strong>Exercise 4.1  </strong></span>
<a href="https://spark.apache.org/docs/latest/ml-tuning.html#train-validation-split" target="_blank">Regardez la documentation</a>
et modifiez le code pour sÃ©lectionner un modÃ¨le Ã  lâ€™aide dâ€™une recherche par grille (<em>grid search</em>). Le but de la recherche par grille est
de trouver la valeur optimale des hyperparamÃ¨tres du modÃ¨le.</p>
</div>
</div>
<details>
<summary>
Solution
</summary>
<div class="infobox exosolution">
<p>Le corrigÃ© est disponible dans le fichier suivant :</p>
<pre><code>
~cpu_quercini/mllib_solutions/model_evaluation.py
</code></pre>
</div>
</details>
</div>

          </div>

          



          
        </div>

        
      </article>

      

    </main>
  </div>
</div>


      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academic.min.3da86581634ab22d5bb3fc4505df30a5.js"></script>

    






  
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
