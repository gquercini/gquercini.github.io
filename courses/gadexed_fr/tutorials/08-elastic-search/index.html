<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Gianluca Quercini">

  
  
  
    
  
  <meta name="description" content="Introduction √† Elasticsearch.">

  
  <link rel="alternate" hreflang="en-us" href="/courses/gadexed_fr/tutorials/08-elastic-search/">

  


  
  
  
  <meta name="theme-color" content="rgb(0, 136, 204)">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  


  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_32x32_fill_lanczos_center_3.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_192x192_fill_lanczos_center_3.png">

  <link rel="canonical" href="/courses/gadexed_fr/tutorials/08-elastic-search/">

  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Gianluca Quercini">
  <meta property="og:url" content="/courses/gadexed_fr/tutorials/08-elastic-search/">
  <meta property="og:title" content="Elasticsearch | Gianluca Quercini">
  <meta property="og:description" content="Introduction √† Elasticsearch."><meta property="og:image" content="img/map[gravatar:%!s(bool=true) shape:circle]">
  <meta property="twitter:image" content="img/map[gravatar:%!s(bool=true) shape:circle]"><meta property="og:locale" content="en-us">
  
    
    
  

  



  


  


  





  <title>Elasticsearch | Gianluca Quercini</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#teaching"><span>Teaching</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      

      

      

    </ul>

  </div>
</nav>


  

  

<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      


<script src="/js/toggle-menu.js"></script>







  
    
  




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
</form>

<nav class="collapse docs-links" id="docs-nav">
  

  
  
  
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="tutoriels" class="docs-toc-link" href="/courses/gadexed_fr/tutorials/01-rel-data-modeling/">Tutoriels</a>
    
    <div id="tutoriels-ddowncontent" class="tutoriels-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/01-rel-data-modeling/">1. Mod√©lisation des donn√©es relationnelles</a>
      </li>
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/02-sql/">2. SQL</a>
      </li>
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/03-multidimension-modeling/">3. Mod√©lisation multidimensionnelle</a>
      </li>
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/04-mongodb-modeling/">4. Mod√©lisation de donn√©es dans MongoDB</a>
      </li>
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/05-mongodb-queries/">5. Requ√™tes MongoDB</a>
      </li>
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/06-cassandra/">6. Cassandra</a>
      </li>
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/07-neo4j/">7. Requ√™tes Neo4j</a>
      </li>
      
      <script>open_menu_on_load("tutoriels".concat("-ddowncontent"))</script>
      <li class="active tutoriels">
        <a href="/courses/gadexed_fr/tutorials/08-elastic-search/">8. Elasticsearch</a>
      </li>
      
      
      <li class="tutoriels">
        <a href="/courses/gadexed_fr/tutorials/09-spark-streaming/">9. Spark Structured Streaming</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  
</nav>

    </div>

    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          <div class="heading">Gestion et analyse des donn√©es ‚Äî Tutoriel 8</div>
          <h1>Elasticsearch</h1>
          <hr>
          <div class="logo">
            
            </div>

          <div class="article-style">
            
<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p><link rel="stylesheet" href="/styles/course.css">
<link rel="stylesheet" href="/styles/cloud-computing.css"></p>
<p>L‚Äôobjectif de ce tutoriel est de se familiariser avec Elasticsearch, un moteur de recherche et d‚Äôanalyse distribu√© bas√© sur Lucene.</p>
<div id="pr√©paration-de-lenvironnement" class="section level1">
<h1>Pr√©paration de l‚Äôenvironnement</h1>
<p>La premi√®re chose √† faire est de <strong>d√©marrer Elasticsearch</strong> via la proc√©dure suivante :</p>
<ul>
<li><p>Ouvrez une fen√™tre de <em>PowerShell</em>.</p></li>
<li><p>D√©placez-vous dans le r√©pertoire <code>elasticsearch-9.2.1</code> via la commande suivante :</p></li>
</ul>
<pre><code>cd Desktop\elasticsearch-9.2.1</code></pre>
<ul>
<li>Lancez Elasticsearch avec la commande suivante :</li>
</ul>
<pre><code>bin\elasticsearch.bat</code></pre>
<ul>
<li><p>Attendez environ 30 secondes : le serveur va d√©marrer et il restera bloqu√© sur cette fen√™tre.</p></li>
<li><p>Ouvrez une page du navigateur web et saisissez l‚Äôadresse suivante : <code>http://localhost:9200</code>.</p></li>
<li><p>Vous devriez obtenir une r√©ponse JSON o√π l‚Äôattribut <em>tagline</em> vaut <em>You Know, for Search</em>. Si la r√©ponse n‚Äôappara√Æt pas, attendez encore quelques secondes et rafra√Æchissez la page.</p></li>
</ul>
<p>Ensuite, nous allons <strong>d√©marrer Kibana</strong>, l‚Äôinterface web d‚ÄôElasticsearch qui nous permettra d‚Äôex√©cuter des requ√™tes et visualiser les r√©sultats.</p>
<ul>
<li><p>Ouvrez un nouvel onglet dans le PowerShell, <strong>sans fermer</strong> celui o√π Elasticsearch est en cours d‚Äôex√©cution.</p></li>
<li><p>D√©placez-vous dans le r√©pertoire <code>kibana-9.2.1</code> via la commande suivante :</p></li>
</ul>
<pre><code>cd Desktop\kibana-9.2.1</code></pre>
<ul>
<li>Lancez Kibana avec la commande suivante :</li>
</ul>
<pre><code>bin\kibana.bat</code></pre>
<ul>
<li><p>Attendez <strong>5-6 minutes</strong> pour que Kibana d√©marre compl√®tement.</p></li>
<li><p>Ouvrez une page du navigateur web et saisissez l‚Äôadresse suivante : <code>http://localhost:5601</code>.</p></li>
<li><p>Dans la page d‚Äôaccueil de Kibana, cliquez sur <em>Explore on my own</em>.</p></li>
<li><p>Cliquez sur ‚ò∞ dans le menu en haut √† gauche.</p></li>
<li><p>S√©lectionnez <em>Management</em> et <em>Dev tools</em>.</p></li>
<li><p>Une console appara√Æt o√π nous pourrons saisir des requ√™tes Elasticsearch.</p></li>
<li><p>Essayez la requ√™te suivante dans la console et cliquez sur le bouton ‚ñ∂Ô∏è pour l‚Äôex√©cuter :</p></li>
</ul>
<pre><code>GET /</code></pre>
<ul>
<li>Vous devriez obtenir la r√©ponse JSON obtenue pr√©c√©demment dans le navigateur web.</li>
</ul>
</div>
<div id="terminologie" class="section level1">
<h1>Terminologie</h1>
<ul>
<li><p><strong>Document</strong> : unit√© de donn√©es de base dans Elasticsearch. Un document est repr√©sent√© en JSON et contient un ensemble de champs (attributs) et de valeurs.
C‚Äôest l‚Äô√©quivalent d‚Äôune ligne dans une base de donn√©es relationnelle ou d‚Äôun document dans MongoDB.</p></li>
<li><p><strong>Index</strong> : collection de documents qui partagent des propri√©t√©s similaires. C‚Äôest l‚Äô√©quivalent d‚Äôune table dans une base de donn√©es relationnelle ou d‚Äôune collection dans MongoDB.</p></li>
<li><p><strong>Mapping</strong> : le processus de d√©finition de la mani√®re dont un document, et les champs qu‚Äôil contient, sont stock√©s et index√©s. En d‚Äôautres termes, c‚Äôest le sch√©ma d‚Äôun index
(un peu comme le sch√©ma d‚Äôune table dans une base de donn√©es relationnelle).</p></li>
</ul>
</div>
<div id="v√©rification-delasticsearch" class="section level1">
<h1>V√©rification d‚ÄôElasticsearch</h1>
<p>Nous allons v√©rifier l‚Äôetant de sant√© du cluster via la commande suivante :</p>
<pre><code>GET _cluster/health </code></pre>
<p>Vous devriez obtenir une r√©ponse JSON o√π l‚Äôattribut <em>status</em> vaut <em>green</em> ; il y a d√©j√† 36 shards actifs.
Pourquoi ?
Parce qu‚ÄôElasticsearch cr√©e automatiquement des indices de syst√®me pour son propre fonctionnement interne.
V√©rifions-le avec la commande suivante :</p>
<pre><code>GET /_cat/indices?expand_wildcards=all&amp;v</code></pre>
<p>Vous devriez voir une liste de 36 indices ; comme nous travaillons sur un cluster compos√© d‚Äôun seul n≈ìud, il y a un seul shard primaire pour chaque indice et aucun shard r√©pliqu√©.</p>
</div>
<div id="mapping" class="section level1">
<h1>Mapping</h1>
<p>Lorsqu‚Äôon cr√©e un index, Elasticsearch g√©n√®re automatiquement un mapping bas√© sur les donn√©es des documents index√©s.
C‚Äôest ce qu‚Äôon appelle le <strong>dynamic mapping</strong>.
Le dynamic mapping utilise des r√®gles heuristiques pour d√©terminer le type de donn√©es de chaque champ (texte, nombre, date, etc.) et les propri√©t√©s associ√©es (analyseur, indexation, etc.).
Bien que le dynamic mapping soit pratique pour des cas simples et rapides, et qu‚Äôil fonctionne bien dans de nombreux sc√©narios, il n‚Äôest pas toujours optimal.
Par exemple, lorsqu‚Äôon souhaite indexer des dates, Elasticsearch peut ne pas les reconna√Ætre correctement si elles ne sont pas dans un format standard ISO.</p>
<p>En r√®gle g√©n√©rale, il est recommand√© de <strong>d√©finir explicitement le mapping</strong> lors de la cr√©ation d‚Äôun index.</p>
<p>La commande suivante cr√©e un index nomm√© <code>employees</code>, avec un mapping explicite :</p>
<pre class="json"><code>PUT employees
{
  &quot;mappings&quot;: {
    &quot;properties&quot;: {
      &quot;name&quot;:{ &quot;type&quot;: &quot;text&quot;},
      &quot;age&quot;: {&quot;type&quot;: &quot;integer&quot;},
      &quot;email&quot;: {&quot;type&quot;: &quot;keyword&quot;},
      &quot;address&quot;:{
        &quot;properties&quot;: {
          &quot;street&quot;:{ &quot;type&quot;:&quot;text&quot; },
          &quot;country&quot;:{ &quot;type&quot;:&quot;text&quot; }
        }
      }
    }
  },
  &quot;settings&quot;: {
    &quot;number_of_replicas&quot; : 0
  }
}</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-1" class="exercise"><strong>Exercise 1  </strong></span>
Ex√©cutez la commande ci-dessus dans la console de Kibana pour cr√©er l‚Äôindex <code>employees</code> avec le mapping sp√©cifi√©.
Observez la d√©finition du mapping et expliquez le choix des types de donn√©es pour chaque champ.</p>
</div>
</div>
<div id="mettre-√†-jour-le-mapping" class="section level2">
<h2>Mettre √† jour le mapping</h2>
<p>Il est possible de mettre √† jour le mapping d‚Äôun index existant en utilisant la commande <code>PUT</code> avec le chemin <code>_mapping</code>.</p>
<p>Ex√©cutez la commande suivante dans la console de Kibana pour ajouter deux nouveaux champs au mapping de l‚Äôindex <code>employees</code> : <code>joining_date</code> (de type <code>date</code>) et <code>phone_number</code> (de type <code>keyword</code>).</p>
<pre class="json"><code>PUT employees/_mapping
{
  &quot;properties&quot;:{
    &quot;joining_date&quot;:{
      &quot;type&quot;:&quot;date&quot;,
      &quot;format&quot;:&quot;dd-MM-yyyy&quot;
    },
    &quot;phone_number&quot;:{
      &quot;type&quot;:&quot;keyword&quot;
    }
  }
}</code></pre>
<p>Remarquez que pour le champ <code>joining_date</code>, nous avons sp√©cifi√© un format de date personnalis√© (jour-mois-ann√©e).</p>
<div class="infobox warning">
<p><strong>Modifications des champs existants</strong></p>
<p>Il n‚Äôest <strong>pas possible</strong> de modifier le type ou les propri√©t√©s d‚Äôun champ existant dans le mapping.
La raison en est que cela entra√Ænerait des erreurs lorsqu‚Äôon cherche les donn√©es d√©j√† index√©es car ils ne correspondraient plus au nouveau mapping.
Si on souhaite modifier le type ou les propri√©t√©s d‚Äôun champ existant, il faut cr√©er un nouvel index avec le mapping mis √† jour,
puis r√©indexer les documents de l‚Äôancien index vers le nouveau en utilisant l‚ÄôAPI de r√©indexation d‚ÄôElasticsearch.</p>
</div>
</div>
<div id="le-type-de-donn√©es-text" class="section level2">
<h2>Le type de donn√©es <code>text</code></h2>
<p>Afin de g√©rer les recherches en texte int√©gral, Elasticsearch propose le type de donn√©es <code>text</code>.
Avant de stocker un champ de type <code>text</code>, Elasticsearch applique un processus appel√© <strong>analyse</strong>.
L‚Äôanalyse est appliqu√©e par un objet appel√© <strong>analyseur</strong> (ang., <em>analyzer</em>) ; selon l‚Äôanalyseur utilis√©, le texte est transform√© en une suite de <strong>tokens</strong> et ensuite
stock√© dans un format interne optimis√© pour la recherche.</p>
<p>Pour chaque champ de type <code>text</code>, Elasticsearch utilise par d√©faut l‚Äôanalyseur <strong>standard</strong>.</p>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-2" class="exercise"><strong>Exercise 2  </strong></span>
Ex√©cutez la commande suivante :</p>
<pre><code>POST _analyze
{
    &quot;text&quot;: &quot;The movie was sick!!! Hilarious :) :) and WITTY ;) a KiLLer üëç&quot;
}</code></pre>
<p>Pourriez expliquer les √©tapes de l‚Äôanalyse effectu√©e par l‚Äôanalyseur standard ?</p>
</div>
</div>
<p>Nous pouvons √©galement changer l‚Äôanalyseur par d√©faut pour un champ de type <code>text</code>.</p>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-3" class="exercise"><strong>Exercise 3  </strong></span>
Ex√©cutez la commande suivante pour analyser le m√™me texte en utilisant l‚Äôanalyseur <code>english</code> :</p>
<pre><code>POST _analyze
{
    &quot;text&quot;: &quot;The movie was sick!!! Hilarious :) :) and WITTY ;) a KiLLer üëç&quot;,
    &quot;analyzer&quot;: &quot;english&quot;
}</code></pre>
<p>Pourriez expliquer les diff√©rences entre les tokens produits par l‚Äôanalyseur <code>standard</code> et ceux produits par l‚Äôanalyseur <code>english</code> ?</p>
</div>
</div>
<p>D‚Äôautres analyseurs sont disponibles dans Elasticsearch, adapt√©s √† diff√©rentes langues et besoins :</p>
<ul>
<li><p><strong>standard</strong> : analyseur par d√©faut, adapt√© pour l‚Äôanglais et d‚Äôautres langues.</p></li>
<li><p><strong>simple</strong> : divise le texte en tokens en utilisant des caract√®res non alphab√©tiques comme s√©parateurs, et convertit les tokens en minuscules.</p></li>
<li><p><strong>whitespace</strong> : divise le texte en tokens en utilisant uniquement les espaces comme s√©parateurs, sans convertir en minuscules.</p></li>
<li><p><strong>stop</strong> : similaire √† l‚Äôanalyseur simple, mais supprime √©galement les mots vides (ang., <em>stop words</em>). Fonctionne pour l‚Äôanglais.</p></li>
<li><p><strong>keyword</strong> : ne divise pas le texte en tokens, mais le traite comme un seul token. Utile pour les champs qui ne n√©cessitent pas d‚Äôanalyse en texte int√©gral, comme les identifiants ou les codes postaux.</p></li>
<li><p><strong>language-specific analyzers</strong> : analyseurs sp√©cifiques pour diff√©rentes langues, comme <code>french</code>, <code>german</code>, <code>spanish</code>, etc., qui incluent des r√®gles de traitement sp√©cifiques √† chaque langue.</p></li>
<li><p><strong>pattern</strong> : permet de d√©finir des expressions reguli√®res pour diviser le texte en tokens.</p></li>
<li><p><strong>custom analyzers</strong> : permet de cr√©er des analyseurs personnalis√©s en combinant diff√©rents composants, comme des tokenizers, des filtres de tokens et des filtres de caract√®res.</p></li>
</ul>
</div>
</div>
<div id="documents" class="section level1">
<h1>Documents</h1>
<p>Elasticsearch permet de manipuler des documents via les APIs suivantes :</p>
<ul>
<li><p><strong>Document Indexing API</strong> : pour indexer (c‚Äôest √† dire, ajouter √† un index) des documents.</p></li>
<li><p><strong>Read and Search API</strong> : pour r√©cup√©rer et rechercher des documents.</p></li>
<li><p><strong>Update API</strong> : pour mettre √† jour des documents existants.</p></li>
<li><p><strong>Delete API</strong> : pour supprimer des documents.</p></li>
</ul>
<p>Ces APIs peuvent √™tre utilis√©es pour manipuler des documents individuellement (<em>single-document API</em>) ou en masse (<em>multi-document API</em>).</p>
<div id="indexer-des-documents" class="section level2">
<h2>Indexer des documents</h2>
<p>Chaque document a un identifiant unique (ID) qui permet de le retrouver dans l‚Äôindex.
C‚Äôest √©quivalent √† la cl√© primaire dans une base de donn√©es relationnelle.
Les identifiants peuvent √™tre sp√©cifi√©s manuellement lors de l‚Äôindexation d‚Äôun document, ou g√©n√©r√©s automatiquement par Elasticsearch si aucun identifiant n‚Äôest fourni.</p>
<ul>
<li><p>Pour indexer un document avec un identifiant sp√©cifi√©, on utilise la commande <code>PUT</code> avec le chemin suivant : <code>/{index}/_doc/{id}</code>.</p></li>
<li><p>Pour indexer un document sans sp√©cifier d‚Äôidentifiant, on utilise la commande <code>POST</code> avec le chemin suivant : <code>/{index}/_doc/</code>.</p></li>
</ul>
<p>Cr√©ons un index d‚Äôabord.</p>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-4" class="exercise"><strong>Exercise 4  </strong></span>
Cr√©ez un index nomm√© <code>movies</code> avec les champs suivants :</p>
<ul>
<li><p><code>title</code> (de type <code>text</code>);</p></li>
<li><p><code>release_year</code> (de type <code>date</code> avec le format <code>yyyy</code>);</p></li>
<li><p><code>synopsis</code> (de type <code>text</code>).</p></li>
</ul>
<p>Rappelez-vous de d√©finir le nombre de r√©plicas √† 0, car nous travaillons sur un cluster √† n≈ìud unique.</p>
</div>
</div>
<p>Vous pouvez maintenant indexer des documents dans l‚Äôindex <code>movies</code>.</p>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-5" class="exercise"><strong>Exercise 5  </strong></span>
Ajoutez un nouveau document (avec identifiant 1) dans l‚Äôindex <code>movies</code> pour le film <em>The Godfather 1</em> avec les champs suivants :</p>
<ul>
<li><code>title</code> : <code>The Godfather 1</code></li>
<li><code>release_year</code> : <code>1972</code></li>
<li><code>synopsis</code> : <code>The aging patriarch of an organized crime dynasty transfers control of his clandestine empire to his reluctant son.</code></li>
</ul>
</div>
</div>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-6" class="exercise"><strong>Exercise 6  </strong></span>
Observez la r√©ponse JSON retourn√©e par Elasticsearch apr√®s l‚Äôindexation du document.
Copiez-la dans un fichier texte.
R√©-ex√©cutez la m√™me commande pour indexer le m√™me document (avec le m√™me identifiant 1) mais en modifiant le synopsis.
Observez la nouvelle r√©ponse JSON et comparez-la avec la pr√©c√©dente.
Quelles diff√©rences remarquez-vous ?</p>
</div>
</div>
<p>Nous pouvons √©galement indexer des documents sans sp√©cifier d‚Äôidentifiant (en utilisant POST).
La commande suivante :</p>
<pre class="json"><code>POST movies/_doc/
{
  &quot;title&quot;: &quot;The Godfather 2&quot;,
  &quot;release_year&quot;: &quot;1974&quot;,
  &quot;synopsis&quot;: &quot;The early life and career of Vito Corleone in 1920s New York City is portrayed while his son, Michael, expands and tightens his grip on his crime syndicate.&quot;
}</code></pre>
<p>cr√©era un nouveau document avec un identifiant g√©n√©r√© automatiquement par Elasticsearch. Nous pourrons retrouver cet identifiant dans la r√©ponse JSON retourn√©e apr√®s l‚Äôindexation du document.</p>
<div class="infobox warning">
<p><strong>Bonne pratique</strong></p>
<p>Il n‚Äôest <strong>pas conseill√©</strong> de m√©langer des documents avec des ID manuellement sp√©cifi√©s et des documents avec des ID g√©n√©r√©s automatiquement dans le m√™me index.</p>
</div>
</div>
<div id="r√©cup√©rer-des-documents" class="section level2">
<h2>R√©cup√©rer des documents</h2>
<p>Pour r√©cup√©rer un document par son identifiant, on utilise la commande <code>GET</code> avec le chemin suivant : <code>/{index}/_doc/{id}</code>.</p>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-7" class="exercise"><strong>Exercise 7  </strong></span>
Utilisez la commande GET pour r√©cup√©rer le document avec l‚Äôidentifiant 1 dans l‚Äôindex <code>movies</code>.
Analysez la r√©ponse JSON retourn√©e par Elasticsearch.</p>
</div>
</div>
<p>Dans l‚Äôexercice pr√©c√©dent, nous avons r√©cup√©r√© tous les champs du document.
Il est possible de r√©cup√©rer seulement certains champs sp√©cifiques en utilisant le param√®tre <code>?_source_includes</code> dans la commande <code>GET</code>.</p>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-8" class="exercise"><strong>Exercise 8  </strong></span>
Utilisez la commande GET pour r√©cup√©rer seulement le champ <code>title</code> du document avec l‚Äôidentifiant 1 dans l‚Äôindex <code>movies</code>.</p>
</div>
</div>
<div class="infobox warning">
<p><strong>Exclusions des champs</strong></p>
<p>Il existe aussi le param√®tre <code>?_source_excludes</code> qui permet d‚Äôexclure certains champs sp√©cifiques lors de la r√©cup√©ration d‚Äôun document.</p>
</div>
</div>
<div id="mettre-√†-jour-des-documents" class="section level2">
<h2>Mettre √† jour des documents</h2>
<p>La mise √† jour d‚Äôun document existant est effectu√©e via les √©tapes suivantes :</p>
<ul>
<li><p>Elasticsearch r√©cup√®re le document existant.</p></li>
<li><p>Applique les modifications sp√©cifi√©es dans la requ√™te de mise √† jour.</p></li>
<li><p>R√©indexe le document mis √† jour.</p></li>
</ul>
<p>Lorsqu‚Äôon met √† jour un document, Elasticsearch incr√©mente la version du document ; l‚Äôancienne version du document n‚Äôest pas conserv√©e.</p>
<div id="ajouter-un-champ-√†-un-document" class="section level3">
<h3>Ajouter un champ √† un document</h3>
<p>La commande suivante ajoute deux nouveaux champs <code>director</code> et <code>actors</code> au document avec l‚Äôidentifiant 1 dans l‚Äôindex <code>movies</code> :</p>
<pre class="json"><code>POST movies/_update/1
{
  &quot;doc&quot;: {
    &quot;actors&quot;:[&quot;Marlon Brando&quot;,&quot;Al Pacino&quot;,&quot;James Caan&quot;],
    &quot;director&quot;:&quot;Francis Ford Coppola&quot;  
  }
}</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-9" class="exercise"><strong>Exercise 9  </strong></span>
Ex√©cutez la commande ci-dessus.
Est-ce que la commande r√©ussit m√™me si les champs <code>director</code> et <code>actors</code> n‚Äôexistent pas encore dans le mapping de l‚Äôindex <code>movies</code> ?</p>
</div>
</div>
</div>
<div id="modification-des-champs-existants" class="section level3">
<h3>Modification des champs existants</h3>
<p>Pour mettre √† jour un champ existant dans un document, on sp√©cifie simplement la nouvelle valeur du champ dans la requ√™te de mise √† jour.</p>
<pre class="json"><code>POST movies/_update/1
{
  &quot;doc&quot;: {
    &quot;title&quot;:&quot;The Godfather 1 (Original)&quot;
  }
}</code></pre>
<p>Lorsqu‚Äôil faut ajouter un √©l√©ment √† un tableau dans un document, il faut sp√©cifier les nouvelles et les anciennes valeurs du tableau.
La commande suivante ajoute un nouvel acteur au tableau <code>actors</code> dans le document avec l‚Äôidentifiant 1 dans l‚Äôindex <code>movies</code> :</p>
<pre class="json"><code>POST movies/_update/1
{   
  &quot;doc&quot;: {
    &quot;actors&quot;:[&quot;Marlon Brando&quot;,&quot;Al Pacino&quot;,&quot;James Caan&quot;,&quot;Robert Duvall&quot;]
  }
}</code></pre>
<p>On peut √©viter de sp√©cifier les anciennes valeurs du tableau en utilisant une mise √† jour par script :</p>
<pre class="json"><code>POST movies/_update/1
{
  &quot;script&quot;: {
   &quot;source&quot;: &quot;ctx._source.actors.add(&#39;Diane Keaton&#39;)&quot;
  }
}</code></pre>
<p>De mani√®re similaire, on peut supprimer un √©l√©ment d‚Äôun tableau en utilisant une mise √† jour par script :</p>
<pre class="json"><code>POST movies/_update/1
{
 &quot;script&quot;:{
   &quot;source&quot;:
     &quot;ctx._source.actors.remove(ctx._source.actors.indexOf(&#39;Diane Keaton&#39;))&quot;
  }
}</code></pre>
<p>Nous pouvons √©galement utiliser des scripts pour ajouter un champ :</p>
<pre class="json"><code>POST movies/_update/1
{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;ctx._source.imdb_user_rating = 9.2&quot;
  }
}</code></pre>
<p>ou bien pour supprimer un champ :</p>
<pre class="json"><code>POST movies/_update/1
{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;ctx._source.remove(&#39;imdb_user_rating&#39;)&quot;
  }
}</code></pre>
<p>Nous pouvons aussi ajouter plusieurs champs en une seule mise √† jour par script :</p>
<pre class="json"><code>POST movies/_update/1
{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;&quot;&quot;
    ctx._source.runtime_in_minutes = 175;
    ctx._source.metacritic_rating= 100;
    ctx._source.tomatometer = 97;
    ctx._source.boxoffice_gross_in_millions = 134.8;
    &quot;&quot;&quot;
  }
}</code></pre>
<p>Et enfin, nous pouvons aussi faire des mises √† jour conditionnelles en utilisant des scripts.</p>
<pre class="json"><code>POST movies/_update/1
{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;&quot;&quot;
    if(ctx._source.boxoffice_gross_in_millions &gt; 125) 
      {ctx._source.blockbuster = true} 
     else 
      {ctx._source.blockbuster = false}
    &quot;&quot;&quot;
  }
}</code></pre>
</div>
<div id="mise-√†-jour-via-des-requ√™tes" class="section level3">
<h3>Mise √† jour via des requ√™tes</h3>
<p>Dans les exemples pr√©c√©dents, nous avons mis √† jour des documents en sp√©cifiant leur identifiant.
Il est aussi possible de mettre √† jour des documents en utilisant des requ√™tes pour s√©lectionner les documents.
Lorsque nous avons ajout√© le film <em>The Godfather 2</em>, un nouvel identifiant a √©t√© g√©n√©r√© automatiquement par Elasticsearch.
Supposons que nous ne connaissons pas cet identifiant, mais que nous voulons ajouter des acteurs au film <em>The Godfather 2</em>.</p>
<p>Nous pouvons utiliser la commande suivante :</p>
<pre class="json"><code>POST /movies/_update_by_query
{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;&quot;&quot;
      if (ctx._source.actors == null) {
        ctx._source.actors = [];
      }
      for (actor in params.new_actors) {
        if (!ctx._source.actors.contains(actor)) {
          ctx._source.actors.add(actor);
        }
      }
    &quot;&quot;&quot;,
    &quot;params&quot;: {
      &quot;new_actors&quot;: [&quot;Al Pacino&quot;, &quot;Robert De Niro&quot;, &quot;Diane Keaton&quot;]
    }
  },
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: &quot;The Godfather 2&quot;
    }
  }
}</code></pre>
<div class="infobox warning">
<p><strong>Langage de scripting</strong></p>
<p>Elasticsearch utilise <strong>Painless</strong> comme langage de scripting par d√©faut pour les mises √† jour par script.
D‚Äôautres langages de scripting peuvent √™tre utilis√©s, comme par exemple <strong>expression</strong>, <strong>mustache</strong> ou <strong>java</strong>.</p>
</div>
</div>
</div>
<div id="supprimer-des-documents" class="section level2">
<h2>Supprimer des documents</h2>
<p>La suppression d‚Äôun document est effectu√©e en utilisant la commande <code>DELETE</code> avec le chemin suivant : <code>/{index}/_doc/{id}</code>.
On peut aussi supprimer des documents en utilisant des requ√™tes pour s√©lectionner les documents √† supprimer via la commande <code>DELETE</code> avec le chemin suivant : <code>/{index}/_delete_by_query</code>.</p>
<pre class="json"><code>POST movies/_delete_by_query
{
  &quot;query&quot;:{
    &quot;match&quot;:{
      &quot;director&quot;:&quot;Francis Ford Coppola&quot;
    }
  }
}</code></pre>
<p>Si nous voulons supprimer les films o√π Al Pacino est un des acteurs, nous pouvons utiliser la commande suivante :</p>
<pre class="json"><code>POST movies/_delete_by_query
{
  &quot;query&quot;:{
    &quot;match&quot;:{
      &quot;actors&quot;:&quot;Al Pacino&quot;
    }
  }
}</code></pre>
</div>
</div>
<div id="rechercher-des-documents" class="section level1">
<h1>Rechercher des documents</h1>
<p>Elasticsearch permet de faire des recherches <strong>structur√©es</strong> et <strong>non structur√©es</strong> via l‚ÄôAPI de recherche.</p>
<p>Les premi√®res renvoient des r√©sultats qui ne sont pas associ√©s √† un score de pertinence.
Elasticsearch renvoie des documents qui correspondent exactement aux crit√®res de la requ√™te.
Cela est similaire aux requ√™tes SQL dans les bases de donn√©es relationnelles.
Ces types de requ√™tes sont appel√©es <strong>term-level queries</strong>.</p>
<p>Les secondes renvoient des r√©sultats associ√©s √† un score de pertinence.
Elasticsearch renvoie des documents qui sont similaires √† la requ√™te.
Ces requ√™tes sont appel√©es <strong>full-text queries</strong>.</p>
<p>On va maintenant voir des exemples de recherches.</p>
<p>D‚Äôabord, supprimez l‚Äôindex <code>movies</code>:</p>
<pre class="json"><code>DELETE movies</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-10" class="exercise"><strong>Exercise 10  </strong></span></p>
<ul>
<li><p>T√©l√©chargez le fichier que vous trouverez
<a href="/courses/databases/gadexed/tutorial-8/movies.json" download="movies.json">√† ce lien</a>
qui contient des documents √† indexer dans un index nomm√© <code>movies</code>.</p></li>
<li><p>Ouvrez un nouvel onglet dans PowerShell, d√©placez-vous dans le r√©pertoire o√π vous avez t√©l√©charg√© le fichier et ex√©cutez la commande suivante pour indexer les documents dans l‚Äôindex <code>movies</code> :</p>
<pre><code>  curl.exe -XPOST &quot;http://localhost:9200/_bulk&quot; -H &quot;Content-Type: application/x-ndjson&quot; --data-binary &quot;@movies.json&quot;</code></pre></li>
<li><p>Dans la console de Kibana, ex√©cutez la commande suivante pour v√©rifier que les documents ont √©t√© index√©s correctement :</p>
<pre><code>  GET /movies/_count</code></pre></li>
<li><p>Vou devriez obtenir 53 documents.</p></li>
</ul>
</div>
</div>
<div class="infobox warning">
<p><strong>√âtat du cluster</strong></p>
<p>Si vous ex√©cutez la commande :</p>
<pre><code>GET _cluster/health</code></pre>
<p>vous verrez que l‚Äô√©tat du cluster est <em>yellow</em>. Cela est d√ª au fait que l‚Äôindex <code>movies</code> a √©t√© automatiquement cr√©√© avec le nombre par d√©faut de r√©plicas (1).</p>
</div>
<div id="term-level-queries" class="section level2">
<h2>Term-level queries</h2>
<p>Elasticsearch fournit plusieurs types de term-level queries, parmi lesquelles : <strong>term query</strong>, <strong>terms query</strong>, <strong>range query</strong>, <strong>exists query</strong> ‚Ä¶
Nous allons voir quelques exemples.</p>
<div id="term-query" class="section level3">
<h3>Term query</h3>
<p>Une term query recherche des documents qui contiennent un terme exact dans un champ sp√©cifique.</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;term&quot;: {
      &quot;year&quot;: 1972
    }
  }
}</code></pre>
<p>Lorsqu‚Äôon fait une term query, la valeur recherch√©e n‚Äôest pas analys√©e, mais elle est recherch√©e telle quelle dans l‚Äôindex.
Par cons√©quent, les term queries sont g√©n√©ralement utilis√©es pour les champs de type <code>keyword</code>, <code>integer</code>, <code>date</code>, etc., mais pas pour les champs de type <code>text</code>.
Regardons ce qui se passe si nous faisons une term query sur le champ <code>title</code>, qui est de type <code>text</code> :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;term&quot;: {
      &quot;title&quot;: &quot;The Godfather&quot;
    }
  }
}</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-11" class="exercise"><strong>Exercise 11  </strong></span>
Pourquoi cette requ√™te ne retourne-t-elle aucun document, m√™me si nous avons index√© un film dont le titre exact est <em>The Godfather</em> ?</p>
</div>
</div>
</div>
<div id="terms-query" class="section level3">
<h3>Terms query</h3>
<p>Une terms query recherche des documents qui contiennent au moins un des termes sp√©cifi√©s dans un champ sp√©cifique.</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;terms&quot;: {
      &quot;year&quot;: [1972, 1974]
    }
  }
}</code></pre>
</div>
<div id="exists-query" class="section level3">
<h3>Exists query</h3>
<p>La exists query recherche des documents qui contiennent un champ sp√©cifique, quel que soit sa valeur.</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;exists&quot;: {
      &quot;field&quot;: &quot;director&quot;
    }
  }
}</code></pre>
</div>
<div id="range-query" class="section level3">
<h3>Range query</h3>
<p>Une range query recherche des documents dont la valeur d‚Äôun champ sp√©cifique se situe dans une plage donn√©e.</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;range&quot;: {
      &quot;year&quot;: {
        &quot;gte&quot;: 1970,
        &quot;lte&quot;: 2010
      }
    }
  }
}</code></pre>
<p>Nous pouvons mieux apr√©cier le r√©sultat de la range query en ajoutant un tri sur le champ <code>release_year</code> :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;range&quot;: {
      &quot;year&quot;: {
        &quot;gte&quot;: 1970,
        &quot;lte&quot;: 2010
      }
    }
  },
  &quot;sort&quot;: [
    {
      &quot;year&quot;: { &quot;order&quot;: &quot;asc&quot; }
    }
  ]
}</code></pre>
</div>
<div id="wildcard-query" class="section level3">
<h3>Wildcard query</h3>
<p>Une wildcard query recherche des documents qui correspondent √† un motif sp√©cifi√© dans un champ sp√©cifique.
Par exemple, pour rechercher des titres de films qui commencent par <em>g</em> et se terminent par <em>er</em>, nous utilisons la commande suivante :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;wildcard&quot;: {
      &quot;title&quot;: &quot;g*er&quot;
    }
  }
}</code></pre>
<p>Remarquez que nous avons utilis√© des lettres minuscules dans le motif, car le champ <code>title</code> est de type <code>text</code> et a √©t√© transform√© en minuscules avant d‚Äô√™tre index√©.</p>
<p>Les types de wildcards disponibles sont :</p>
<ul>
<li><code>?</code> : correspond √† un seul caract√®re.</li>
<li><code>*</code> : correspond √† z√©ro ou plusieurs caract√®res.</li>
</ul>
</div>
<div id="prefix-queries" class="section level3">
<h3>Prefix queries</h3>
<p>Les prefix queries recherchent des documents dont la valeur d‚Äôun champ sp√©cifique commence par un pr√©fixe donn√©.</p>
<p>Par exemple, pour recherche des films o√π un des acteurs commence par <em>Al</em>, nous utilisons la commande suivante :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;prefix&quot;: {
      &quot;actors&quot;: &quot;al&quot;
    }
  }
}</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-12" class="exercise"><strong>Exercise 12  </strong></span>
Pourquoi la commande ci-dessus retourne des films o√π Tim Allen est un des acteurs, alors que son nom ne commence pas par <em>Al</em> ?</p>
</div>
</div>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-13" class="exercise"><strong>Exercise 13  </strong></span>
Pourriez-vous exprimer la m√™me requ√™te en utilisant une wildcard query au lieu d‚Äôune prefix query ?</p>
</div>
</div>
</div>
<div id="fuzzy-query" class="section level3">
<h3>Fuzzy query</h3>
<p>Les fuzzy queries recherchent des documents qui correspondent approximativement √† une valeur donn√©e dans un champ sp√©cifique.
Elles sont utiles pour g√©rer les fautes de frappe ou les variations orthographiques.
La recherche est bas√©e sur la distance de Levenshtein, qui mesure le nombre de modifications n√©cessaires pour transformer une cha√Æne de caract√®res en une autre.
Par exemple, le terme <em>roam</em> peut √™tre transform√© en <em>foam</em> avec une seule modification (remplacer <em>r</em> par <em>f</em>), donc la distance de Levenshtein est 1.</p>
<p>La commande suivante recherche des titres de films qui sont similaires √† <em>godfater</em> avec une distance maximale de 1 :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;fuzzy&quot;: {
      &quot;title&quot;: {
        &quot;value&quot;: &quot;godfater&quot;,
        &quot;fuzziness&quot;: 1
      }
    }
  }
}</code></pre>
<p>Il n‚Äôest pas possible de pr√©dire combien de fautes de frappe seront pr√©sentes dans une requ√™te de recherche.
Par cons√©quent, Elasticsearch permet d‚Äôutiliser le param√®tre <code>AUTO</code> pour la fuzziness, qui ajuste automatiquement la distance maximale en fonction de la longueur du terme recherch√©.
Les valeurs utilis√©es sont les suivantes :</p>
<ul>
<li>0 pour les termes de longueur 1 ou 2. Pour des mots tr√®s courts, l‚Äôutilisateur est cens√© taper correctement le mot.</li>
<li>1 pour les termes de longueur 3, 4 ou 5.</li>
<li>2 pour les termes de longueur sup√©rieure √† 5.</li>
</ul>
<p>Un exemple d‚Äôutilisation de <code>AUTO</code> pour la fuzziness est le suivant :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;fuzzy&quot;: {
      &quot;title&quot;: {
        &quot;value&quot;: &quot;godfater&quot;,
        &quot;fuzziness&quot;: &quot;AUTO&quot;
      }
    }
  }
}</code></pre>
</div>
</div>
<div id="full-text-queries" class="section level2">
<h2>Full-text queries</h2>
<p>Les full-text queries sont utilis√©es pour rechercher des documents en texte int√©gral.
Les documents retourn√©s sont associ√©s √† un score de pertinence qui indique √† quel point chaque document correspond √† la requ√™te de recherche.
Il est possible que certains documents retourn√©s n‚Äôaient pas finalement une pertinence √©lev√©e par rapport √† la requ√™te.
De m√™me, il est aussi possible que certains documents tr√®s pertinents ne soient pas retourn√©s du tout.
√áa revient √† l‚Äôutilisateur final de juger de la pertinence des r√©sultats retourn√©s.
On pourrait donc √©valuer la performance d‚Äôune requ√™te de recherche en fonction de la <strong>pr√©cision</strong> et du <strong>rappel</strong> (ang., recall) des r√©sultats retourn√©s.</p>
<p>Plusieurs types de full-text queries sont disponibles dans Elasticsearch, parmi lesquelles : <strong>match query</strong>, <strong>match_all query</strong>, <strong>match_phrase query</strong>, <strong>multi_match query</strong> ‚Ä¶
Nous allons voir quelques exemples.</p>
<div id="match-query" class="section level3">
<h3>Match query</h3>
<p>Une match query recherche des documents qui correspondent √† une requ√™te en texte int√©gral dans un champ sp√©cifique.
La requ√™tes peut √©galement inclure plusieurs termes. On peut aussi sp√©cifier diff√©rentes options.</p>
<p>La commande suivante recherche des titres de films qui contiennent le mot <em>Godfather</em> :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: &quot;Godfather&quot;
    }
  }
}</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-14" class="exercise"><strong>Exercise 14  </strong></span>
Observez le resultat retourn√© par Elasticsearch.</p>
<ul>
<li><p>Combien de documents ont √©t√© trouv√©s ?</p></li>
<li><p>Comment sont-ils ordonn√©s dans le r√©sultat ?</p></li>
<li><p>Pourquoi le premier document a un score plus √©lev√© que les autres ?</p></li>
</ul>
</div>
</div>
<div class="infobox warning">
<p><strong>Comprendre le score de pertinence</strong></p>
<p>Si nous voulons comprendre comment le score de pertinence est calcul√©, nous pouvons utiliser un drapeau sp√©cial appel√© <code>explain</code> dans notre requ√™te de recherche.</p>
<pre class="json"><code>GET /movies/_search
{
   &quot;explain&quot;: true, 
  &quot;_source&quot;: false, 
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: &quot;Godfather&quot;
    }
  }
}</code></pre>
<p>Vous devriez pouvoir identifier les diff√©rentes composantes du score de pertinence dans la r√©ponse JSON retourn√©e par Elasticsearch
(le term frequency, le inverse document frequency‚Ä¶).</p>
</div>
<p>Nous pouvons aussi rechercher des titres de films qui contiennent plusieurs mots. Par exemple, la commande suivante recherche des titres de films qui contiennent les mots <em>Godfath</em> ou <em>Part</em> :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: &quot;Godfather Part&quot;
    }
  }
}</code></pre>
<p>Il faut souligner que la match query analyse la requ√™te de recherche avant de l‚Äôex√©cuter.
Par cons√©quent, les termes de la requ√™te sont convertis en minuscules et divis√©s en tokens.
Ainsi, la requ√™te ci-dessus est √©quivalente √† la suivante : <strong>‚Äúgodfather part‚Äù</strong>.<br />
Remarquons aussi que les documents retourn√©s sont ceux qui contiennent au moins un des termes de la requ√™te (c‚Äôest l‚Äôop√©rateur logique OR qui est utilis√© par d√©faut).</p>
<p>Si nous voulons que les documents retourn√©s contiennent tous les termes de la requ√™te (c‚Äôest l‚Äôop√©rateur logique AND), nous devons sp√©cifier l‚Äôoption <code>operator</code> comme suit :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: {
        &quot;query&quot;: &quot;Godfather Part&quot;,
        &quot;operator&quot;: &quot;and&quot;
      }
    }
  }
}</code></pre>
<p>Une autre option utile est <code>minimum_should_match</code>, qui permet de sp√©cifier le nombre minimum de termes de la requ√™te qui doivent √™tre pr√©sents dans les documents retourn√©s.
Par exemple, la commande suivante recherche des titres de films qui contiennent au moins 2 des termes de la requ√™te :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: {
        &quot;query&quot;: &quot;Godfather Part Fiction&quot;,
        &quot;minimum_should_match&quot;: 2
      }
    }
  }
}</code></pre>
<p>Si on avait sp√©cifi√© <code>minimum_should_match</code> √† 3, la requ√™te aurait √©t√© √©quivalente √† une match query avec l‚Äôoption <code>operator</code> d√©finie √† <code>and</code>.</p>
<p>Une autre option int√©ressante est <code>fuzziness</code>, qui permet de faire des recherches approximatives en texte int√©gral. Par exemple, la commande suivante recherche des titres de films qui sont similaires √† <em>godfater</em> :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: {
        &quot;query&quot;: &quot;godfater&quot;,
        &quot;fuzziness&quot;: &quot;AUTO&quot;
      }
    }
  }
}</code></pre>
<p>Par d√©faut, Elasticsearch retourne tous les champs des documents correspondant √† une requ√™te.
Nous avons vu pr√©c√©demment que nous pouvons contr√¥ler les champs retourn√©s en utilisant les param√®tres <code>_source_includes</code> et <code>_source_excludes</code>.
Une autre mani√®re de s√©lectionner les champs retourn√©s est d‚Äôutiliser l‚Äôobjet <code>fields</code> dans la requ√™te de recherche.
Notez que lorsque nous utilisons l‚Äôobjet <code>fields</code>, nous devons d√©sactiver le retour du champ <code>_source</code> en utilisant le param√®tre <code>"_source": false</code>.</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;_source&quot;: false,
  &quot;query&quot;: {
    &quot;match&quot;: {
      &quot;title&quot;: &quot;Godfather&quot;
    }
  },
  &quot;fields&quot;: [&quot;title&quot;, &quot;year&quot;]
}</code></pre>
</div>
<div id="match_all-query" class="section level3">
<h3>Match_all query</h3>
<p>Une match_all query recherche tous les documents dans un index, sans appliquer de filtre ou de crit√®re de recherche.
Le rappel est donc de 100%, mais la pr√©cision d√©pendra du nombre total de documents dans l‚Äôindex.</p>
<p>Si on veut r√©cup√©rer tous les documents dans l‚Äôindex <code>movies</code>, on utilise la commande suivante :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match_all&quot;: {}
  }
}</code></pre>
<p>Remarquez que le score de pertinence retourn√© pour chaque document est le m√™me (1.0) car tous les documents sont consid√©r√©s comme √©galement pertinents pour cette requ√™te.</p>
<p>Ces requ√™tes peuvent retourner un grand nombre de documents, dans l‚Äôordre de plusieurs milliers.
Il ne serait pas efficace de retourner tous ces documents en une seule requ√™te, car aussi bien le serveur que le client ne pourraient pas disposer de suffisamment de
m√©moire pour stocker un si grand volume de donn√©es.</p>
<p>Par d√©faut, Elasticsearch retourne seulement les 10 premiers documents correspondant √† une requ√™te, mais nous pouvons contr√¥ler
le nombre de documents retourn√©s en utilisant le param√®tre <code>size</code>.</p>
<pre class="json"><code>GET movies/_search
{
  &quot;size&quot;: 20, 
  &quot;query&quot;: {
    &quot;match_all&quot;: {}
  }
}</code></pre>
<p>On peut aussi utiliser le param√®tre <code>from</code> pour sp√©cifier l‚Äôoffset (le nombre de documents √† ignorer avant de commencer √† retourner les r√©sultats).
La requ√™te suivante retourne 2 documents, en ignorant les 5 premiers documents correspondant √† la requ√™te.</p>
<pre class="json"><code>GET movies/_search
{
  &quot;from&quot;: 5,
  &quot;size&quot;: 2,
  &quot;query&quot;: {
    &quot;match_all&quot;: {}
  }
}</code></pre>
</div>
<div id="match_phrase-query" class="section level3">
<h3>match_phrase query</h3>
<p>Une match_phrase query recherche des documents qui contiennent une phrase exacte dans un champ sp√©cifique.
La commande suivante recherche des titres de films qui contiennent la phrase ‚Äúhacker discovers the reality‚Äù :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match_phrase&quot;: {
      &quot;synopsis&quot;: &quot;hacker discovers the reality&quot;
    }
  }
}</code></pre>
<p>Remarquez que si on enl√®ve des mots de la phrase, par exemple en recherchant ‚Äúhacker reality‚Äù, la requ√™te ne retournera aucun document.
Dans ce cas, un param√®tre utile est <code>slop</code>, qui permet de sp√©cifier le nombre de mots qui peuvent s√©parer les mots de la phrase recherch√©e dans les documents.
Par exemple, la commande suivante recherche des titres de films qui contiennent les mots ‚Äúhacker‚Äù et ‚Äúreality‚Äù avec un slop de 2 :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match_phrase&quot;: {
      &quot;synopsis&quot;: {
        &quot;query&quot;: &quot;hacker reality&quot;,
        &quot;slop&quot;: 2
      }
    }
  }
}</code></pre>
</div>
<div id="match_query_prefix-query" class="section level3">
<h3>match_query_prefix query</h3>
<p>Une match_query_prefix query recherche des documents via une phrase exact, mais le dernier mot de la phrase peut √™tre un pr√©fixe.
La requ√™tes suivante recherche des synopsis de films qui contiennent un mot commen√ßant par ‚Äúdream‚Äù :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;match_phrase_prefix&quot;: {
      &quot;synopsis&quot;: &quot;dream&quot;
    }
  }
}</code></pre>
</div>
<div id="multi_match-query" class="section level3">
<h3>multi_match query</h3>
<p>Une multi_match query recherche des documents qui correspondent √† une requ√™te en texte int√©gral dans plusieurs champs sp√©cifiques.
La commande suivante recherche des titres et des synopsis de films qui contiennent le mot ‚Äúredemption‚Äù :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;multi_match&quot;: {
      &quot;query&quot;: &quot;redemption&quot;,
      &quot;fields&quot;: [&quot;title&quot;, &quot;synopsis&quot;]
    }
  }
}</code></pre>
</div>
<div id="query_string-query" class="section level3">
<h3>query_string query</h3>
<p>Une query_string query permet de rechercher des documents en utilisant des op√©rateurs bool√©ens et des expressions r√©guli√®res dans une cha√Æne de requ√™te.</p>
<p>La requ√™tes suivante recherce des films dont l‚Äôun des acteurs est Morgan Freeman <strong>et</strong> dont l‚Äôann√©e de sortie est post√©rieure √† 1990 :</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;query_string&quot;: {
      &quot;query&quot;: &quot;actors:\&quot;Morgan Freeman\&quot; AND year:&gt;1990&quot;
    }
  }
}</code></pre>
</div>
</div>
<div id="requ√™tes-compos√©es" class="section level2">
<h2>Requ√™tes compos√©es</h2>
<p>Elasticsearch permet de combiner plusieurs crit√®res de recherche en utilisant des requ√™tes bool√©ennes via l‚Äôop√©rateur <code>bool</code>.</p>
<p>Les clauses bool√©ennes disponibles sont :</p>
<ul>
<li><p><strong>must</strong> : les documents doivent correspondre √† tous les crit√®res sp√©cifi√©s dans cette clause (c‚Äôest l‚Äôop√©rateur logique AND).</p></li>
<li><p><strong>should</strong> : les documents doivent correspondre √† au moins un des crit√®res sp√©cifi√©s dans cette clause (c‚Äôest l‚Äôop√©rateur logique OR).</p></li>
<li><p><strong>must_not</strong> : les documents ne doivent pas correspondre aux crit√®res sp√©cifi√©s dans cette clause (c‚Äôest l‚Äôop√©rateur logique NOT).</p></li>
<li><p><strong>filter</strong> : les documents doivent correspondre aux crit√®res sp√©cifi√©s dans cette clause (comme pour <strong>must</strong>), mais ces crit√®res n‚Äôaffectent pas le score de pertinence.</p></li>
</ul>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-15" class="exercise"><strong>Exercise 15  </strong></span>
Que fait la requ√™te suivante ?</p>
<pre><code>GET movies/_search
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;must&quot;: [
        {
          &quot;match&quot;: {
            &quot;title&quot;: &quot;Godfather&quot;
          }
        },
        {
          &quot;range&quot;: {
            &quot;year&quot;: {
              &quot;gte&quot;: 1970,
              &quot;lte&quot;: 1972
            }
          }
        }
      ]
    }
  }
}</code></pre>
</div>
</div>
<div class="infobox exercisebox">
<p><strong>Exercice</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-16" class="exercise"><strong>Exercise 16  </strong></span>
√âcrivez une requ√™te qui recherche les films dont le titre contient le mot ‚ÄúGodfather‚Äù <strong>ou</strong> ‚ÄúPulp Fiction‚Äù, mais <strong>pas</strong> ‚ÄúPart II‚Äù.</p>
</div>
</div>
<p>La requ√™te suivante utilise la clause <code>filter</code> pour rechercher les films dont le titre contient le mot ‚ÄúGodfather‚Äù.</p>
<pre class="json"><code>GET /movies/_search
{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;filter&quot;: {
        &quot;match&quot;: {
          &quot;title&quot;: &quot;Godfather&quot;
        }
      }
    }
  }
}</code></pre>
<p>Ces requ√™tes sont plus rapides car Elasticsearch n‚Äôa pas besoin de calculer les scores de pertinence.</p>
</div>
</div>
<div id="bibliographie" class="section level1">
<h1>Bibliographie</h1>
<p>Plusieurs exemples de ce tutoriel sont tir√©s du livre suivant :</p>
<p>Madhusudhan Konda, <em>Elasticsearch in Action</em>, Second Edition, Mnning Publications, 2023.</p>
</div>

          </div>

          



          
        </div>

        
      </article>

      

    </main>
  </div>
</div>


      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academic.min.3da86581634ab22d5bb3fc4505df30a5.js"></script>

    






  
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
