<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Gianluca Quercini">

  
  
  
    
  
  <meta name="description" content="Text of the lab assignment on Docker &#43; Kubernetes">

  
  <link rel="alternate" hreflang="en-us" href="/courses/cloud-computing/labs/kube-lab/">

  


  
  
  
  <meta name="theme-color" content="rgb(0, 136, 204)">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  


  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_32x32_fill_lanczos_center_3.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_192x192_fill_lanczos_center_3.png">

  <link rel="canonical" href="/courses/cloud-computing/labs/kube-lab/">

  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Gianluca Quercini">
  <meta property="og:url" content="/courses/cloud-computing/labs/kube-lab/">
  <meta property="og:title" content="Multi-service applications in the Cloud | Gianluca Quercini">
  <meta property="og:description" content="Text of the lab assignment on Docker &#43; Kubernetes"><meta property="og:image" content="img/map[gravatar:%!s(bool=true) shape:circle]">
  <meta property="twitter:image" content="img/map[gravatar:%!s(bool=true) shape:circle]"><meta property="og:locale" content="en-us">
  
    
    
  

  



  


  


  





  <title>Multi-service applications in the Cloud | Gianluca Quercini</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#teaching"><span>Teaching</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      

      

      

    </ul>

  </div>
</nav>


  

  

<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      


<script src="/js/toggle-menu.js"></script>







  
    
  




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
</form>

<nav class="collapse docs-links" id="docs-nav">
  

  
  
  
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="tutorials" class="docs-toc-link" href="/courses/cloud-computing/tutorials/tutorial-docker/">Tutorials</a>
    
    <div id="tutorials-ddowncontent" class="tutorials-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="tutorials">
        <a href="/courses/cloud-computing/tutorials/tutorial-docker/">1. Getting started with Docker</a>
      </li>
      
      
      <li class="tutorials">
        <a href="/courses/cloud-computing/tutorials/tutorial-kube/">2. Multi-service applications</a>
      </li>
      
      <script>open_menu_on_load("tutorials".concat("-ddowncontent"))</script>
      <li class="active tutorials">
        <a href="/courses/cloud-computing/labs/kube-lab/">3. Multi-service applications (Lab)</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="labs" class="docs-toc-link" >Labs</a>
    

  </div>
  
  
</nav>

    </div>

    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          <div class="heading">Cloud computing — Lab assignment</div>
          <h1>Multi-service applications in the Cloud</h1>
          <hr>
          <div class="logo">
            
            </div>

          <div class="article-style">
            


<!-- merge 1.2 with 1.3, so that we can ask students to point out exactly the common layers -->
<p><link rel="stylesheet" href="/styles/course.css">
<link rel="stylesheet" href="/styles/cloud-computing.css"></p>
<div id="objectives" class="section level1 unnumbered">
<h1>Objectives</h1>
<p>In this lab assignment you will:</p>
<ul>
<li><p>Gain a deeper understanding of the <strong>Docker networking model</strong>.</p></li>
<li><p>Build and deploy a multi-service application with <strong>Docker Compose</strong>.</p></li>
<li><p>Deploy a multi-service application on a <strong>local Kubernetes cluster</strong>.</p></li>
<li><p>Deploy a multi-service application on a <strong>Kubernetes cluster</strong> in <strong>Microsoft Azure</strong>.</p></li>
</ul>
</div>
<div id="submission" class="section level1 unnumbered">
<h1>Submission</h1>
<ul>
<li><p>Only one submission per group.</p></li>
<li><p>In order to submit your work, you need to answer all the questions
that you <strong><a href="https://centralesupelec.edunao.com/mod/quiz/view.php?id=115349" target="_blank">find here</a></strong>.
Each question corresponds to an exercise that you find in this page.</p></li>
<li><p>You can answer either <strong>in French</strong> or <strong>in English</strong>. Your pick!</p></li>
<li><p><strong>Deadline: 16 May 2023, 23h59</strong></p></li>
</ul>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>This lab assignment is <strong>evaluated</strong>.
You won’t have access to the solutions.
You <strong>can ask questions anytime</strong>
should you run into problems
with the implementation of the assignment.</p>
</div>
</div>
<div id="docker-networking-model" class="section level1">
<h1><span class="header-section-number">1</span> Docker networking model</h1>
<p>We developed a simple chat room in Python that you can download
<a href="/courses/cloud-computing/kube-lab/chat-room.zip">here</a>.
The code has been adapted from <a href="https://github.com/pricheal/python-client-server/" target="_blank">this GitHub project</a>.</p>
<p>Participants use a <em>client</em> program to connect to the chat room;
the chat room is managed by a <em>server</em> application that receives the
client connections and forwards the messages between the users.
The archive contains the following files:</p>
<ul>
<li><em>client.py</em>. Implementation of the chat room client.</li>
<li><em>server.py</em>. Implementation of the chat room server.</li>
<li><em>utils.py</em>. Library with utility functions used in both <em>client.py</em> and <em>server.py</em>.</li>
</ul>
<p>The application is written in Python and it <strong>requires Python 3.7</strong>.
The application doesn’t need any third-party library, the packages included in a minimal Python environment are enough.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:client-server-methodology" class="exercise"><strong>Exercise 1.1  </strong></span></p>
<ol style="list-style-type: lower-alpha">
<li><p>Is a single Docker image for this application enough? Justify your answer.</p></li>
<li>Given your answer to the previous question, how many Docker images do you need to create?</li>
</ol>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<ol style="list-style-type: lower-alpha">
<li>One image is not enough, because the client and the server are two separate processes.</li>
</ol>
<ol start="2" style="list-style-type: decimal">
<li>We need to create two images, one for the client and one for the server.</li>
</ol>
</div>
</details>
<p>We now build the images for the application.</p>
<div class="infobox curiosity">
<p><strong>Good to know</strong></p>
<p>If you need to inspect the file system of an
image that you create (e.g., to verify that the files that you
copied are actually there), you can open a terminal
in the image by using the following command:</p>
<p><code>docker run -it --entrypoint sh IMAGE_NAME</code></p>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-1" class="exercise"><strong>Exercise 1.2  </strong></span>Build the image(s) for the application. For each image:</p>
<ol style="list-style-type: lower-alpha">
<li>Upload the Dockerfile to Edunao.</li>
<li>Write the <strong>exact</strong> command that you used to build the image.</li>
</ol>
</div>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>The size of the images should be kept as small as possible.
Remember to include in the images only what you need to build and run the application.</p>
</div>
<p>If you built more than one image:</p>
<ol start="3" style="list-style-type: lower-alpha">
<li><p>Do they have some common layers? Which ones?</p></li>
<li><p>If so, is it something that has an impact on the build time and how?</p></li>
</ol>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>For both the client and the server we need a Python environment.
We use the Python environment <em>slim</em> as a base image to minimize the size of the image.
Students who choose this base image are rewarded.
If they choose another (bigger) Python environment, that is fine, but they don’t get
the totality of the points.
If they use an OS as a base image (e.g., ubuntu), they get penalized.</p>
<p>The Dockerfile for the client (let’s call it <em>Dockerfile-client</em>)
is as follows.</p>
<pre class="dockerfile"><code>FROM python:3.7-slim
RUN mkdir -p /app
WORKDIR /app
COPY ./client.py ./utils.py /app/
ENTRYPOINT [&quot;python&quot;, &quot;client.py&quot;]</code></pre>
<p>We build the image with the following command:</p>
<p><code>docker build -t chat-client -f Dockerfile-client .</code></p>
<p>The Dockerfile for the server (let’s call it <em>Dockerfile-server</em>)
is as follows.</p>
<pre class="dockerfile"><code>FROM python:3.7-slim
RUN mkdir -p /app
WORKDIR /app
COPY ./server.py ./utils.py /app/
ENTRYPOINT [&quot;python&quot;, &quot;server.py&quot;]</code></pre>
<p>We build the image with the following command:</p>
<p><code>docker build -t chat-server -f Dockerfile-server .</code></p>
<ol start="3" style="list-style-type: lower-alpha">
<li><p>The base image is the same for both images. The layers 2 and 3 are identical</p></li>
<li><p>Assuming that we build the client first, this build will take longer if
the python-slim image has not been downloaded yet from the registry.
Layers 2 and 3 already exist when the server is built.
This is indicated by the phrase “Using cache” when we build the server.
It is important that here the students talk about the build cache mechanism.</p></li>
</ol>
</div>
</details>
<div id="client-and-server-on-the-same-network" class="section level2">
<h2><span class="header-section-number">1.1</span> Client and server on the same network</h2>
<p>We want to execute:</p>
<ul>
<li><p>One instance of the server.</p></li>
<li><p>Two instances of the client.</p></li>
</ul>
<p>The server, as well as the clients, will
<strong>run in Docker containers attached to the same network</strong>.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-2" class="exercise"><strong>Exercise 1.3  </strong></span>
We want to make sure that:</p>
<ol style="list-style-type: decimal">
<li><p>The server and the clients can communicate with each other.</p></li>
<li><p>Other Docker containers <strong>cannot</strong> communicate neither with the server nor with the clients.</p></li>
</ol>
<p>How can you satisfy both requirements in Docker? Explain your solution
and justify it.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>If we create the three containers without specifying any network configuration, then
the three containers will be attached to the default <code>bridge</code> network.
This way, we can satisfy the first requirement, but not the second (other containers attached
to <code>bridge</code> will be able to communicate with the clients and the server).</p>
<p>We need to create a new network in Docker, let’s call it <code>chat-room</code> that
will be used exclusively for the server and the two clients.</p>
</div>
</details>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>Only one instance of the server is running.
Two instances of the client run at the same time.</p>
<ol style="list-style-type: decimal">
<li><p>In order to execute the server, we need to <strong>pass a port number as a parameter</strong>. Choose one in the range [49152–65535].</p></li>
<li><p>In order to execute the client, we need to <strong>pass as parameters the IP address of the server and the port</strong> which the server listens to (the one that you specified at 1.).</p></li>
</ol>
</div>
<!-- NOT LIVRAISON -->
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:client-server-single-network" class="exercise"><strong>Exercise 1.4  </strong></span>
Execute the server and the two clients by using the network configuration that you
explained in the previous exercise.</p>
<ul>
<li><p>The server writes messages on the terminal. Remember to launch the container with the appropriate
options in order to actually see those messages.</p></li>
<li><p>Users need to interact with the client, that is: read and write messages.
Remember to launch the container with the appropriate options in order to actually see those messages.</p></li>
</ul>
<p>Write the <strong>exact commands</strong> that you typed for
both configuring the network and launching the server and the clients. <strong>Explain these commands.</strong></p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>First, we create the new network <code>chat-room</code> by typing the following command:</p>
<p><code>docker network create chat-room</code></p>
<p>Next, we launch the server with the following command:</p>
<p><code>docker container run --rm -t --name chat-server --network chat-room chat-server 60876</code></p>
<p>The server takes in a port number as a parameter.
If the students launch the server without specifying it, they’ll get an error message
that should lead them to understand what’s missing.</p>
<p>In another terminal, we type the following command to run the first client:</p>
<p><code>docker container run --rm -it --name chat-client1 --network chat-room  chat-client chat-server 60876</code></p>
<p>Note that we attach the client to the same network as the server.
When we launch the client, we need to pass as parameters the server host (here we can use the
container’s name <code>chat-server</code> of the server or its IP address) and the port number
(same as we specified when we launched the server).
When we launch the client, we’ll need to specify a username and then we can start typing messages in the chat room.</p>
<p>Finally, we open another terminal to launch the second client with the following command:</p>
<p><code>docker container run --rm -it --name chat-client2 --network chat-room  chat-client chat-server 60876</code></p>
<p>The only thing that changes wrt the previous command is the name that we give the new container
(<code>chat-client2</code>).</p>
<p>We can play with the chat to verify that the clients can exchange messages.</p>
</div>
</details>
<div class="infobox warning">
<p><strong>Shut the application down!</strong></p>
<p>Shut both the clients and the server down before you move on.</p>
<ul>
<li><p>On the client-side, type <code>#quit</code> at any moment to exit the chat room.</p></li>
<li><p>Type Ctrl-C to stop the server.</p></li>
</ul>
</div>
</div>
<div id="client-and-server-on-different-networks" class="section level2">
<h2><span class="header-section-number">1.2</span> Client and server on different networks</h2>
<p>We want to execute:</p>
<ul>
<li><p>One instance of the server.</p></li>
<li><p>Two instances of the client.</p></li>
</ul>
<p>However, <strong>neither client</strong> is connected to the same network as the server.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-3" class="exercise"><strong>Exercise 1.5  </strong></span>
Why can’t you launch the containers with the same settings as
in Exercise <a href="#exr:client-server-single-network">1.4</a>?</p>
<p>What do you propose as a solution instead?</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>The hostname <code>chat-server</code> is not reachable from the clients, because they’re not in the
same network as the server.
So, the only way out is to use the mechanism of port mapping.
That is: we launch the server on the container port 60876
but we also use the option <code>-p</code> to map that port to any available port
(say, 7070) on the <strong>host computer</strong>.
This way, the clients can connect to the server by specifying the IP address
of the host machine and 7070 as the port number.</p>
</div>
</details>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-4" class="exercise"><strong>Exercise 1.6  </strong></span>
Execute the server and the two clients by making sure that neither client is connected to the
same network as the server.</p>
<p>Write the <strong>exact commands</strong> that you typed
for both configuring the network and launching the server and the clients.
<strong>Explain these commands.</strong></p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>As before, we can still connect the server to the network
<code>chat-room</code>.
However, since we want our server to be reachable from outside that network,
we need to publish a port on the host.
The option <code>-p</code> in the following command maps the container
internal port 60876 to the port 7070 on the host computer.</p>
<p><code>docker container run --rm -it --name chat-server --network chat-room -p 7070:60876 chat-server 60876</code></p>
<p>Now, let’s create a new network that we call <code>net-clients</code>
to which we’ll be attaching the two clients:</p>
<p><code>docker network create net-clients</code></p>
<p>And we finally launch the two clients. As host of the server,
we need to type the IP address assigned to the host.
In my case, the IP address assigned to my host is 192.168.1.8</p>
<p><code>docker container run --rm -it --name chat-client1 --network net-clients chat-client  192.168.1.8 7070</code></p>
<p>The second client is launched as follows:</p>
<p><code>docker container run --rm -it --name chat-client2 --network net-clients chat-client  192.168.1.8 7070</code></p>
</div>
</details>
<div class="infobox warning">
<p><strong>Shut the application down!</strong></p>
<p>Shut both the clients and the server down before you move on.</p>
<ul>
<li><p>On the client-side, type <code>#quit</code> at any moment to exit the chat room.</p></li>
<li><p>Type Ctrl-C to stop the server.</p></li>
</ul>
</div>
<!-- docker run -it --entrypoint sh quercinigia/webmeal this is to look into an image -->
<!-- exercise on docker-compose. Look at what Clara Gross did last year -->
</div>
</div>
<div id="multi-service-application-docker-compose" class="section level1">
<h1><span class="header-section-number">2</span> Multi-service application: Docker Compose</h1>
<p>We intend to build and deploy the application <em>TripMeal</em>
by using <strong>Docker Compose</strong>.
You can download the application
<a href="/courses/cloud-computing/kube-lab/tripmeal.zip">here</a>.
The source code has been readapted from
<a href="https://github.com/DanielAndreasen/TripMeal" target="_blank">this GitHub repository</a>.</p>
<p>The downloaded file is an archive.
Extracting the archive will create a folder named
<code>tripmeal_sujet</code>.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-5" class="exercise"><strong>Exercise 2.1  </strong></span>
Explain the structure of the content of the folder <code>tripmeal_sujet</code>.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>The folder contains:</p>
<ul>
<li><p>A file <code>docker-compose.yml</code> that will contain the instructions
to build and deploy the application.</p></li>
<li><p>A subdirectory for each service composing the application. Each subdirectory
contains the source code of the corresponding service, as well as a Dockerfile
with the instructions to build an image for the service.</p></li>
</ul>
</div>
</details>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-6" class="exercise"><strong>Exercise 2.2  </strong></span>
How many services does the application have?
Which technologies (i.e., programming languages, databases) are used in each service?</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>The application consists of two services:</p>
<ul>
<li><p>web: It is a web application, developed with a combination of HTML,
Python and Flask</p></li>
<li><p>db: It is a relational database. From the Dockerfile, which is already given,
we understand that the DBMS used is MySQL.</p></li>
</ul>
</div>
</details>
<p>The <code>Dockerfile</code> in the directory <code>db</code> is already implemented.</p>
<p>Your goal here is to write a <code>Dockerfile</code> in the directory <code>web</code>.</p>
<div class="infobox warning">
<p><strong>In case you get Exec format error</strong></p>
<p>In order to avoid an <code>Exec format error</code> when you launch the application,
you’ll need to add to your Dockerfile an instruction:</p>
<p><code>RUN chmod -x path_to_file_app</code></p>
<p>where <code>path_to_file_app</code> is the path to the file <code>app.py</code>
<strong>inside the image</strong>.</p>
<!-- https://stackoverflow.com/questions/55271912/flask-cli-throws-oserror-errno-8-exec-format-error-when-run-through-docker-->
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-7" class="exercise"><strong>Exercise 2.3  </strong></span>
Write the <code>Dockerfile</code> in the directory <code>web</code>.
<strong>You need a Python 3.7 environment to run the application.</strong></p>
<p><strong>Upload the Dockerfile to Edunao</strong>.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>Different solutions exist, here is a proposition.
It is important that we build a minimal image, so
we choose the environment python:3-7-slim.</p>
<pre><code>FROM python:3.7-slim
RUN mkdir -p /app &amp; \
    mkdir -p /app/templates &amp; \
    mkdir -p /app/static
RUN /usr/local/bin/python -m pip install --upgrade pip
COPY ./static /app/static/
COPY ./templates /app/templates/
COPY requirements.txt /app/
WORKDIR /app
RUN pip install -r requirements.txt
COPY app.py dbconnect.py /app/
ENTRYPOINT [&quot;python&quot;,&quot;app.py&quot;]</code></pre>
</div>
</details>
<p>In the folder <code>tripmeal_sujet</code>, you’ll find a file named <code>tripmeal.env</code>.
It contains the definition of <strong>environment variables</strong> that
are used in the application.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-8" class="exercise"><strong>Exercise 2.4  </strong></span>
Looking at the environment variables defined in file <code>tripmeal.env</code>:</p>
<ul>
<li><p>What does SERVER_PORT refer to? A port opened at one of the host network interfaces or
a port opened at one of the container’s network interfaces?</p></li>
<li><p>Which environment variable tells you the name to assign to the database service?</p></li>
</ul>
<p>Feel free to answer this question after deploying the application.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<ul>
<li><p>Variable SERVER_PORT: this is the port which the server listens to.
This refers to a port opened at one of the container’s network interfaces!</p></li>
<li><p>The variable that tells us the name of the database service is DATABASE_HOST.
The web service connects to the database that is found at DATABASE_HOST.
In our case, the host is a container. Evidently, Docker Compose uses the
name of the service as the host name for the container.</p></li>
</ul>
</div>
</details>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-9" class="exercise"><strong>Exercise 2.5  </strong></span>
What do you need to define in file <code>docker-compose.yml</code>
to enable the communication between the different services?</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>We need to define a network and attach both services to that network.</p>
</div>
</details>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-10" class="exercise"><strong>Exercise 2.6  </strong></span>
Which base image is used to build a container for the database?
Where is this base image stored?
Can you find the documentation of this image in the Internet?
Write down the link to the documentation page in the answer.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>The base image is <code>mysql</code>.
The tag of the image is <code>latest</code> since it is not specified.
The image is stored in the DockerHub registry.
In order to find it, we can simply look for an image called <code>mysql</code>
on the DockerHub website.
It turns out that the documentation is available
<a href="https://hub.docker.com/_/mysql" target="blank">at this page</a></p>
</div>
</details>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-11" class="exercise"><strong>Exercise 2.7  </strong></span>
By looking at the documentation of the database image,
what do you need to define in <code>docker-compose.yml</code>
to make sure that the data is not deleted once the application is taken down?</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>We need to create a volume. Moreover, we need to mount this volume to
the directory <code>/var/lib/mysql</code> of the container where the database will run.</p>
</div>
</details>
<p>You’re finally ready to complete the file <code>docker-compose.yml</code>.</p>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>Remember that you need to pass the <strong>environment variables</strong>
to your application.</p>
<p>As a documentation of Docker Compose you can use:</p>
<ul>
<li><p>The <a href="/courses/cloud-computing/tutorials/tutorial-kube" target="_blank">examples that we’ve seen together</a>.</p></li>
<li><p>The overview presented on the <a href="https://docs.docker.com/compose/" target="_blank">official Docker website</a>.</p></li>
<li><p>You can also find the full specification of Compose <a href="https://github.com/compose-spec/compose-spec/blob/master/spec.md" target="_blank">here</a>.</p></li>
</ul>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-12" class="exercise"><strong>Exercise 2.8  </strong></span>
Write the file <code>docker-compose.yml</code>.
Build, deploy and test your application.</p>
<p><strong>Upload the file <code>docker-compose.yml</code> to Edunao.</strong></p>
<div class="infobox warning">
<p><strong>Useful commands</strong></p>
<ul>
<li><p>After launching the application, you can type the command <code>docker-compose ps</code>
to look at the details of each container. The command must be typed from folder <code>tripmeal_sujet</code>.</p></li>
<li><p>If any error occurs, you can look at the logs by typing the command <code>docker-compose logs</code>.</p></li>
</ul>
</div>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<pre><code>version: &quot;3&quot;

services:
    web:
        build: web
        image: quercinigia/trip-meal-web
        env_file: tripmeal.env
        networks:
            - tripmeal-network
        ports:
            - &quot;5000:5000&quot;
    db: 
        build: database  
        image: quercinigia/trip-meal-db
        env_file: tripmeal.env
        networks:
            - tripmeal-network
        volumes:
            - db-data:/var/lib/mysql

volumes:
    db-data:

networks:
    tripmeal-network:</code></pre>
</div>
</details>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-13" class="exercise"><strong>Exercise 2.9  </strong></span>
<u>Use Docker Compose</u> to push all the images that you built in this section to
your DockerHub registry.</p>
<p><strong>In the answer to this exercise write:</strong></p>
<ul>
<li>the command that you execute to push the images.</li>
<li>the link to the uploaded images.</li>
</ul>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>We can use DockerCompose to push the images.
The command is:</p>
<pre><code>docker-compose push</code></pre>
</div>
</details>
<div class="infobox warning">
<p><strong>Shut down the application!</strong></p>
<p>Shut down both the application before you move on.</p>
</div>
</div>
<div id="local-kubernetes-cluster" class="section level1">
<h1><span class="header-section-number">3</span> Local Kubernetes cluster</h1>
<p>We intend to deploy the application <em>TripMeal</em> on
a <strong>local Kubernetes cluster</strong> (either Docker Desktop or Minikube).</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-14" class="exercise"><strong>Exercise 3.1  </strong></span>
Specify which services are <strong>stateless</strong>
and which ones are <strong>stateful</strong>. Justify your answer.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>The service <code>web</code> is <strong>stateless</strong>,
because it does not directly manipulate permanent data.
The data in fact reside in a database managed by another service.</p>
<p>The service <code>db</code> is <strong>stateful</strong> because it directly manipulates
permanent data.</p>
</div>
</details>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-15" class="exercise"><strong>Exercise 3.2  </strong></span>
For each service of the application <em>TripMeal</em>, specify
the Kubernetes objects that you need to create and their types.
Justify your answers.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>For the service <code>web</code> we need two objects:</p>
<ul>
<li><p>A <strong>deployment</strong>, which is collection of identical pods, each pod being an instance
of the service. Deployments are often used for stateless services, which is the case of the
<code>web</code> service.</p></li>
<li><p>A <strong>LoadBalancer service</strong>. We need it in order to expose the service so that a client can connect to it.</p></li>
</ul>
<p>For the service <code>db</code> we need two objects:</p>
<ul>
<li><p>A <strong>StatefulSet</strong>, which is a sort of Deployment used for stateful services.</p></li>
<li><p>A <strong>ClusterIP service</strong>, used to expose the service internally in the Kubernetes cluster.
The database is only used the by service <code>web</code>,
it doesn’t need to be accessed from external clients.</p></li>
</ul>
</div>
</details>
<div class="infobox warning">
<p><strong>Help</strong></p>
<p>In order to write the specification of each object, you can refer to the
examples that we discussed together in the second tutorial.
You can also refer
to the <a href="https://kubernetes.io/docs/reference/kubernetes-api/" target="_blank">API documentation on the Kubernetes website</a>.</p>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-16" class="exercise"><strong>Exercise 3.3  </strong></span>
For each Kubernetes object:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Configure.</strong> Write a Yaml configuration file. Remember that you need to pass the environment variables to the application.</p></li>
<li><p><strong>Create.</strong> Create the object in Kubernetes with <code>kubectl</code>.</p></li>
<li><p><strong>Analyze.</strong> Execute the command <code>kubectl get all</code> and explain in detail which objects appear in the output as the result of step 2.</p></li>
</ol>
<p><strong>In case of problems.</strong></p>
<p>You can look at the logs of a pod with the following command: <code>kubectl logs NAME-OF-POD --previous</code></p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>The configuration of the Deployment associated to the <code>web</code> service is
as follows:</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tripmeal
      service: web
  template:
    metadata:
      labels:
        app: tripmeal
        service: web
    spec:
      containers:
      - image: quercinigia/trip-meal-web:latest
        name: web
        ports:
        - containerPort: 5000
          protocol: TCP
        env:
        - name: DATABASE_NAME
          value: &quot;tripmealdb&quot;
        - name: DATABASE_USER
          value: &quot;root&quot;
        - name: MYSQL_ROOT_PASSWORD
          value: &quot;my-secret-pw&quot;
        - name: DATABASE_HOST
          value: &quot;db&quot;
        - name: DATABASE_PORT
          value: &quot;3306&quot;
        - name: TRIPMEAL_KEY
          value: &quot;my-secret-key&quot;
        - name: SERVER_PORT
          value: &quot;5000&quot;</code></pre>
<p>When we create the deployment with the command:</p>
<p><code>kubectl create -f web-deployment.yml</code></p>
<p>three objects are created in Kubernetes:</p>
<ul>
<li><p>A pod, that represents an instance of the service. Here we specified only one replica, hence we have only one pod.</p></li>
<li><p>A Deployment, the object that we demanded.</p></li>
<li><p>A ReplicaSet, the object that controls the collection of pods that are the instances of the service.
The ReplicaSet is managed by the Deployment.</p></li>
</ul>
<p>The configuration of the LoadBalancer service associated with the <code>web</code> service is as follows:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: web
spec:
  type: LoadBalancer
  ports:
  - port: 5000
    targetPort: 5000
    protocol: TCP
  selector:
    app: tripmeal
    service: web</code></pre>
<p>When we create the service with the following command:</p>
<p><code>kubectl create -f web-service.yml</code></p>
<p>A service object is created.
The type of this service is LoadBalancer. An external IP address is associated with the service.
It is through this IP address that we can connect to the service.</p>
<p>The configuration of the StatefulSet associated to the service <code>db</code> is as follows:</p>
<pre><code>apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: db
spec:
  selector:
    matchLabels:
      app: tripmeal
      service: db
  serviceName: db
  template:
    metadata:
      labels:
        app: tripmeal
        service: db
    spec:
      containers:
      - image: quercinigia/trip-meal-db:latest
        name: db
        ports:
        - containerPort: 3306
        volumeMounts:
        - mountPath: /var/lib/mysql
          name: tripmeal-data
        env:
        - name: DATABASE_NAME
          value: &quot;tripmealdb&quot;
        - name: DATABASE_USER
          value: &quot;root&quot; 
        - name: MYSQL_ROOT_PASSWORD
          value: &quot;my-secret-pw&quot;
  volumeClaimTemplates:
  - metadata:
      name: tripmeal-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Mi</code></pre>
<p>When we create the object with the command:</p>
<p><code>kubectl create -f db-stateful-set.yml</code></p>
<p>two objects are created:</p>
<ul>
<li><p>A pod, that represents one instance of the service.</p></li>
<li><p>A StatefulSet, that manages the pod.</p></li>
</ul>
<p>Finally, the configuration of the ClusterIP service associated with the <code>db</code> service
is as follows:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: db
spec:
  type: ClusterIP
  ports:
  - port: 3306
    protocol: TCP
  selector:
    app: tripmeal
    service: db</code></pre>
<p>When we create the object with the following command:</p>
<p><code>kubectl create -f db-service.yml</code></p>
<p>A new service appears in the output. The service has no external IP, which is normal
given that it is only available internally. Its cluster IP address is used
by the service <code>web</code> to connect to the database.</p>
</div>
</details>
<div class="infobox activitybox">
<p><strong>Activity</strong></p>
<p>Play with the application in order to verify that everything works as expected.</p>
</div>
<div class="infobox warning">
<p><strong>Shut down the application!</strong></p>
<p>Shut down the application by removing all the Kubernetes objects.</p>
</div>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-17" class="exercise"><strong>Exercise 3.4  </strong></span>
Create a new file called <code>tripmeal.yml</code> that contains the
definition of all the Kubernetes objects of the application, as we have seen
in the <a href="/courses/cloud-computing/tutorials/tutorial-kube#conclusion" target="_blank">conclusion of the tutorial 2</a>.</p>
<p><strong>Upload this file to Edunao.</strong></p>
</div>
</div>
</div>
<div id="kubernetes-cluster-on-microsoft-azure" class="section level1">
<h1><span class="header-section-number">4</span> Kubernetes cluster on Microsoft Azure</h1>
<p>You’re now going to create a Kubernetes cluster on <strong>Microsoft Azure</strong>
and deploy <em>TripMeal</em> on that cluster.</p>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>In order to perform this activity, you need a <strong>student subscription</strong> on Microsoft Azure.
If you haven’t activated it yet:</p>
<ul>
<li><p>Connect to <a href="https://azure.microsoft.com/en-us/free/students/" target="_blank">this webpage</a>.</p></li>
<li><p>Click on <code>Start free</code>.</p></li>
<li><p>Sign in by using your CentraleSupélec credentials.</p></li>
<li><p>Follow the instructions.</p></li>
</ul>
</div>
<p>During this activity, you’ll need to answer some questions that encourage you to
gain a deeper knowledge of the Azure platform and better understand the commands that you type.
<strong>Feel free to read the documentation on the Azure platform in order to answer the questions.</strong></p>
<div id="login-to-azure-through-cli" class="section level2">
<h2><span class="header-section-number">4.1</span> Login to Azure through CLI</h2>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>If you get “command not found” when you type <code>az</code>, it means that you haven’t installed
the Azure CLI yet.
You’ll find more information on the <a href="https://centralesupelec.edunao.com/course/view.php?id=4686#section-3" target="_blank">Edunao course page</a>.</p>
<p>Make sure you run version 2.25 or higher of the Azure CLI, by typing:</p>
<pre><code>az --version</code></pre>
<p><strong>If you use a VM with Multipass you’ll need to install the Azure CLI with the following command:</strong></p>
<pre><code>curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash</code></pre>
<p><strong>If you use a VM either with Multipass or with VirtualBox you’ll need to re-install kubectl:</strong></p>
<ul>
<li>Type the following command so as the command <code>kubectl</code> does not refer to <code>minikube kubectl</code> anymore:</li>
</ul>
<pre><code>unalias kubectl</code></pre>
<ul>
<li>Type the following command to install a new version of <code>kubectl</code>:</li>
</ul>
<pre><code>sudo az aks install-cli</code></pre>
</div>
<p>Whether you’re on Windows, macOS or Linux, you need to <strong>open a terminal</strong>.</p>
<p>In order to log in to your Azure account, type the following command:</p>
<pre class="bash"><code>az login</code></pre>
<p>A Web page will open in your default Web browser, where you can type your username and
password (your CentraleSupélec credentials).
After authenticating your Azure account, you can go back to the terminal, where you should see
some information about your account, such as:</p>
<pre><code>[
  {
    &quot;cloudName&quot;: &quot;AzureCloud&quot;,
    &quot;homeTenantId&quot;: &quot;&lt;id&gt;&quot;,
    &quot;id&quot;: &quot;&lt;id&gt;&quot;,
    &quot;isDefault&quot;: true,
    &quot;managedByTenants&quot;: [],
    &quot;name&quot;: &quot;Azure for Students&quot;,
    &quot;state&quot;: &quot;Enabled&quot;,
    &quot;tenantId&quot;: &quot;&lt;id&gt;&quot;,
    &quot;user&quot;: {
      &quot;name&quot;: &quot;&lt;email-address&gt;&quot;,
      &quot;type&quot;: &quot;user&quot;
    }
  }
]</code></pre>
</div>
<div id="deploy-and-use-azure-container-registry" class="section level2">
<h2><span class="header-section-number">4.2</span> Deploy and use Azure Container Registry</h2>
<p>When we run TripMeal on a local Kubernetes cluster, we assumed that our computer
could have a direct access to the Internet and, therefore, to the DockerHub registry, where we
could pull the images of the TripMeal services.
When we run a containerized application in production, we cannot make this assumption
as the production servers have often no direct access to the Internet.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-19" class="exercise"><strong>Exercise 4.1  </strong></span>
In your view, why isn’t it a good idea to have production servers directly
connected to the Internet?</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>It is for security reasons. We want to limit the risk of having an attack on these servers.</p>
</div>
</details>
<p>We need to place the images in a container registry that is in the same context
as our production servers.
Since we’re going to run the application on Azure, we can use the
<strong>Azure Container Registry (ACR)</strong>.</p>
<div id="registry-creation" class="section level3">
<h3><span class="header-section-number">4.2.1</span> Registry creation</h3>
<p>First, we need to create a <strong>resource group</strong>.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-20" class="exercise"><strong>Exercise 4.2  </strong></span>
What is a <strong>resource group</strong> in Azure and how is it useful?</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>It is a logical container of resources that are managed together,
typically because they belong to the same application.
Resource groups are useful to manage with a single click
the whole set of resources (e.g., the permissions).
For instance, when we want to decommission the application, we can remove
all the resources with just one command/one click.</p>
</div>
</details>
<p>The command to create a new resource group is the following
(replace RES_GRP_NAME with a name of your choice).</p>
<pre class="bash"><code>az group create --name  RES_GRP_NAME --location francecentral</code></pre>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>If <code>francecentral</code> does not work for your account, the previous command will normally suggest a possible location.
Choose one that is near you.</p>
</div>
<p>You can verify that the resources are correctly created by looking <a href="https://portal.azure.com/" target="_blank">at the Azure portal</a>.</p>
<p>Next, we need to create a <strong>container registry</strong> with the following command
(replace RES_GRP_NAME with the name of your resource group and REG_NAME with a name of your choice for the registry).</p>
<pre class="bash"><code>az acr create --resource-group RES_GRP_NAME --name REG_NAME --sku Basic</code></pre>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-23" class="exercise"><strong>Exercise 4.3  </strong></span>
In the previous command, what does <code>sku</code> refer to?
Feel free to look up on the Azure website to find the answer.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>SKU stands for <em>Stock Keeping Unit</em>, it represents the different shapes of a product.
Here we use a container that is <em>Basic</em>.
Each sku is associated with a price.
If you look <a href="https://azure.microsoft.com/en-us/pricing/details/container-registry/" target="_blank">at this webpage</a>
we find the price of a basic container registry.</p>
</div>
</details>
</div>
<div id="registry-login" class="section level3">
<h3><span class="header-section-number">4.2.2</span> Registry login</h3>
<p>After creating the registry, we can log into it with the following command:</p>
<pre class="bash"><code>az acr login --name REG_NAME</code></pre>
</div>
<div id="image-tagging" class="section level3">
<h3><span class="header-section-number">4.2.3</span> Image tagging</h3>
<p>We’re almost ready to push the images that compose the application <em>TripMeal</em> to the registry.
In order to do that, we need to <strong>tag</strong> (i.e., rename) our images so that their names are
preceded by the <strong>login server name</strong> of the registry.</p>
<p>In order to get the name of the <strong>login server name</strong>
(that we denote here as <code>acrloginserver</code>) of your registry, you can type
the following command:</p>
<pre class="bash"><code>az acr list --resource-group RES_GRP_NAME --query &quot;[].{acrLoginServer:loginServer}&quot; --output table</code></pre>
<p>Your <code>acrloginserver</code> will be something like <code>xxx.azurecr.io</code>.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-26" class="exercise"><strong>Exercise 4.4  </strong></span>
Tag the images that correspond to the services of the application <em>TripMeal</em> so that
their name is similar to: <code>acrloginserver/nameofimage:latest</code></p>
<p>Write the <strong>exact Docker command</strong> that you use to tag the images.</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>We can use the <code>docker tag</code> function.
For instance, in my case I use the following two commands
to rename my two images:</p>
<p><code>docker tag quercinigia/trip-meal-web:latest tripmealacr.azurecr.io/trip-meal-web:latest</code></p>
<p><code>docker tag quercinigia/trip-meal-db:latest tripmealacr.azurecr.io/trip-meal-db:latest</code></p>
</div>
</details>
</div>
<div id="pushing-the-images" class="section level3">
<h3><span class="header-section-number">4.2.4</span> Pushing the images</h3>
<p>We can push the images with the following command (use your image name
instead of <code>xxx.azurecr.io/imagename:latest</code>).</p>
<pre class="bash"><code>docker push xxx.azurecr.io/imagename:latest</code></pre>
<p>Make sure to <strong>type this command for each image</strong> that you want to push.</p>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>It might take few minutes before the images are completely pushed to the registry.</p>
</div>
<p>Finally, verify that the images are actually in the registry with the following command:</p>
<pre class="bash"><code>az acr repository list --name REG_NAME --output table</code></pre>
<p>Alternatively, you can connect to <a href="https://portal.azure.com/" target="_blank">your Azure portal</a>
and visually browse your resources.</p>
</div>
</div>
<div id="deploy-a-kubernetes-cluster" class="section level2">
<h2><span class="header-section-number">4.3</span> Deploy a Kubernetes cluster</h2>
<p>We now deploy a <strong>Kubernetes cluster on Azure</strong>.</p>
<div id="cluster-creation" class="section level3">
<h3><span class="header-section-number">4.3.1</span> Cluster creation</h3>
<p>We create the cluster with the following command (replace CLUSTER_NAME
with a name of your choice. As before, RES_GRP_NAME is the name of your resource group
and REG_NAME is the name of the container registry).</p>
<pre class="bash"><code>az aks create \
    --resource-group RES_GRP_NAME \
    --name CLUSTER_NAME \
    --node-count 2 \
    --generate-ssh-keys \
    --attach-acr REG_NAME</code></pre>
<div class="infobox warning">
<p><strong>Warning</strong></p>
<p>If you get an error on your SSH key, then your key is not in the right format.</p>
<p>Here is how we suggest you to proceed.</p>
<ol style="list-style-type: decimal">
<li><p>Open your home directory in Visual Studio.</p></li>
<li><p>Locate the hidden folder <code>.ssh</code>.</p></li>
<li><p>You should have a file named <code>id_rsa.pub</code> under folder <code>.ssh</code>. Open it.</p></li>
<li><p>Copy the whole content of the file.</p></li>
<li><p>Create a new file under folder <code>.ssh</code>. Give it a name of your choice (for instance, <code>id_kube_rsa.pub</code>).</p></li>
<li><p>Paste the content into the new file, while making sure that you don’t have any whitespace before
the first character.</p></li>
<li><p>Save and close the file.</p></li>
<li><p>Type the command <code>az aks create</code> and replace the <code>--generate--ssh-keys</code> option with <code>--ssh-key-value ~/.ssh/id_kube_rsa.pub</code>.</p></li>
</ol>
</div>
<p>The cluster will take a while to start. Time for a coffee!
But before, answer the following question!</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-30" class="exercise"><strong>Exercise 4.5  </strong></span>
Can you tell the meaning of the options in the previous command?</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<ul>
<li><p>resource-group: the Kubernetes cluster is a resource in Azure. It is added to the resource group that
we created before.</p></li>
<li><p>name: A name that we give our Kubernetes cluster.</p></li>
<li><p>node-count: The number of nodes in the Kubernetes cluster. Here we specify 2.</p></li>
<li><p>generate-ssh-keys: Generate SSH public and private key files if missing.
The keys will be stored in the ~/.ssh directory. Used to connect to the cluster without a password.</p></li>
<li><p>attach-acr: We attach the container registry that we created before. This way, we’ll be able to pull the images
from within the cluster.</p></li>
</ul>
</div>
</details>
</div>
<div id="connect-to-the-cluster" class="section level3">
<h3><span class="header-section-number">4.3.2</span> Connect to the cluster</h3>
<p>We can configure <code>kubectl</code> to connect to the newly created cluster.
You need to type the following command:</p>
<pre class="bash"><code>az aks get-credentials --resource-group RES_GRP_NAME --name CLUSTER_NAME</code></pre>
<p>Now, your Kubernetes cluster should be visible locally.
To verify it, type the following command:</p>
<pre class="bash"><code>kubectl config get-contexts</code></pre>
<p>Here <em>context</em> refers to the Kubernetes clusters that <em>kubectl</em> has access to.
The Kubernetes cluster that you created on Azure should be visible in the output; an asterisk
should appear in front of its name, indicating that it is the <em>current context</em>
(that is the Kubernetes cluster being currently referenced by <code>kubectl</code>).</p>
<p>Type the following command:</p>
<pre class="bash"><code>kubectl get nodes</code></pre>
<p>You should see that the Kubernetes cluster has <strong>two nodes</strong>.</p>
</div>
</div>
<div id="deploy-the-application" class="section level2">
<h2><span class="header-section-number">4.4</span> Deploy the application</h2>
<p>We’re almost done! The images are in the registry, the Kubernetes cluster is up and running.
The only missing piece of the puzzle is our application <em>TripMeal</em>.</p>
<p>First thing to do is to slightly modify the file <code>tripmeal.yml</code> that you created at the end
of the previous section.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-34" class="exercise"><strong>Exercise 4.6  </strong></span>
Look at the names of the images of each service in that file. How must these names change?
Modify the file accordingly (<strong>no need to upload it on Edunao</strong>).</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>The existing names refer to the images on the DockerHub registry.
We must change them so that they refer to the images on our Azure container registry.</p>
</div>
</details>
<p>It is the moment of truth!
Deploy your application by typing the following command:</p>
<pre class="bash"><code>kubectl apply -f tripmeal.yml</code></pre>
<p>Look at Kubernetes objects created after this command:</p>
<pre class="bash"><code>kubectl get all</code></pre>
<p>Get the external IP address of the web service and try to connect to the application,
in the same way you did in the previous section.</p>
<p>If you can play with the application like you did in your local deployment it means that you reached
the conclusion of this assignment! Bravo!</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-37" class="exercise"><strong>Exercise 4.7  </strong></span>
Submit a <strong>video</strong> like that the one that <a href="https://webtv.centralesupelec.fr/permalink/v1261a00b74dbbzwk2vr/" target="_blank"><strong>you can see here</strong></a>.</p>
<p>The video must <strong>clearly</strong> show that:</p>
<ul>
<li><p>You’re connected to <strong>your Azure portal</strong> (Email address on the top right corner of the portal).</p></li>
<li><p>All the passages that you see in the sample video: you need to show the <strong>public IP address</strong>
of the application that you deployed, use that address to connect to your application and play
with the application to show that it works correctly.</p></li>
</ul>
</div>
</div>
<p>The next exercise is <strong>optional</strong>.
Before you leave, <strong>make sure to read the conclusion of this document!!</strong>.</p>
<div class="infobox exercisebox">
<p><strong>Exercise</strong></p>

<div class="exercise">
<p><span id="exr:unnamed-chunk-38" class="exercise"><strong>Exercise 4.8  </strong></span>
The title of this exercise is <em>Cerise sur le gâteau</em> (aka, this is <strong>optional</strong>!).</p>
<p>At this point, you can connect to <em>TripMeal</em> by using an IP address.
It would be nice if you could use a URL, like in the real websites.
Can you find a way to assign a URL to your web service? <strong>Describe your procedure.</strong></p>
<p>You need a bit of Googling here….</p>
</div>
</div>
<details>
<p><summary>Solution</summary></p>
<div class="infobox exosolution">
<p>We have to modify the definition of the web service in the file <code>tripmeal.yml</code>
More precisely, here is the new definition:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  annotations:
    service.beta.kubernetes.io/azure-dns-label-name: mytripmeal
  name: web
spec:
  type: LoadBalancer
  ports:
  - port: 5000
    targetPort: 5000
    protocol: TCP
  selector:
    app: tripmeal
    service: web</code></pre>
<p>We added the field <code>metadata.annotations</code> and specify a DNS label.
Then we need to restart the service.
If everything goes well, the application is reachable at the following address:</p>
<p><code>http://mytripmeal.eastus.cloudapp.azure.com:5000/</code></p>
<p>The URL is composed by the DNS label that we specified + the region where we deployed the cluster +
cloudapp.azure.com</p>
</div>
</details>
</div>
</div>
<div id="conclusion" class="section level1 unnumbered">
<h1>Conclusion</h1>
<p>Make sure you follow these instructions:</p>
<ul>
<li>Take down your application in Kubernetes by using the following command:</li>
</ul>
<pre><code>kubectl delete -f tripmeal.yml</code></pre>
<ul>
<li>Change the context of the <code>kubectl</code> command so that it points back
to a local Kubernetes cluster. Type the following command, where
CONTEXT_NAME will be <code>docker-desktop</code> or <code>minikube</code>, depending on which local Kubernetes cluster
you use.</li>
</ul>
<pre class="bash"><code>kubectl config use-context CONTEXT_NAME</code></pre>
<ul>
<li><strong>Destroy all the resources</strong> linked to the application
<em>TripMeal</em> on Microsoft Azure, otherwise you’ll get billed even if you don’t use them!
You can destroy all the resources by simply deleting the resource group to which they belong.
You can do it through the Azure portal or by typing the following command (replace RES_GRP_NAME with the name
of the resource group that you intend to remove).</li>
</ul>
<pre><code>az group delete --name RES_GRP_NAME</code></pre>
<ul>
<li><p>You can check the balance of your Azure credit <a href="https://www.microsoftazuresponsorships.com/Balance" target="_blank">here</a>.</p></li>
<li><p>You can stop Docker and Kubernetes if you don’t need it anymore.</p></li>
</ul>
</div>

          </div>

          



          
        </div>

        
      </article>

      

    </main>
  </div>
</div>


      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academic.min.8741d44cdc5fc49466a5835d1bbea364.js"></script>

    






  
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
