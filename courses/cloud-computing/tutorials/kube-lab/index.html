<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Gianluca Quercini">

  
  
  
    
  
  <meta name="description" content="Text of the lab assignment on Docker &#43; Kubernetes">

  
  <link rel="alternate" hreflang="en-us" href="/courses/cloud-computing/tutorials/kube-lab/">

  


  
  
  
  <meta name="theme-color" content="rgb(0, 136, 204)">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  


  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_32x32_fill_lanczos_center_3.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu68b06f59cdf252d86e7129a31e131766_426695_192x192_fill_lanczos_center_3.png">

  <link rel="canonical" href="/courses/cloud-computing/tutorials/kube-lab/">

  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Gianluca Quercini">
  <meta property="og:url" content="/courses/cloud-computing/tutorials/kube-lab/">
  <meta property="og:title" content="Multi-service applications in the Cloud | Gianluca Quercini">
  <meta property="og:description" content="Text of the lab assignment on Docker &#43; Kubernetes"><meta property="og:image" content="img/map[gravatar:%!s(bool=true) shape:circle]">
  <meta property="twitter:image" content="img/map[gravatar:%!s(bool=true) shape:circle]"><meta property="og:locale" content="en-us">
  
    
    
  

  



  


  


  





  <title>Multi-service applications in the Cloud | Gianluca Quercini</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" >

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Gianluca Quercini</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#teaching"><span>Teaching</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      

      

      

    </ul>

  </div>
</nav>


  

  

<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      


<script src="/js/toggle-menu.js"></script>







  
    
  




<form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-3" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <span><i class="fas fa-bars"></i></span>
  </button>

  
</form>

<nav class="collapse docs-links" id="docs-nav">
  

  
  
  
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="tutorials" class="docs-toc-link" href="/courses/cloud-computing/tutorials/tutorial-docker/">Tutorials</a>
    
    <div id="tutorials-ddowncontent" class="tutorials-ddowncontent ddowncontent">
    <ul class="nav docs-sidenav">
      
      
      <li class="tutorials">
        <a href="/courses/cloud-computing/tutorials/tutorial-docker/">1. Getting started with Docker</a>
      </li>
      
      
      <li class="tutorials">
        <a href="/courses/cloud-computing/tutorials/tutorial-kube/">2. Multi-service applications</a>
      </li>
      
      <script>open_menu_on_load("tutorials".concat("-ddowncontent"))</script>
      <li class="active tutorials">
        <a href="/courses/cloud-computing/tutorials/kube-lab/">3. Multi-service applications (Lab)</a>
      </li>
      
    </ul>
    </div>
    
    

  </div>
  
  <div class="docs-toc-item">

    <a onclick=open_menu_on_click(this) id="labs" class="docs-toc-link" >Labs</a>
    

  </div>
  
  
</nav>

    </div>

    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          <div class="heading">Cloud computing — Lab assignment</div>
          <h1>Multi-service applications in the Cloud</h1>
          <hr>
          <div class="logo">
            
            </div>

          <div class="article-style">
            


<!-- <link rel="stylesheet" href="/styles/course.css">
<link rel="stylesheet" href="/styles/cloud-computing.css">


# Objectives {-}

In this lab assignment you will:

* Build and deploy a multi-service application with **Docker Compose**.

* Deploy a multi-service application on a **local Kubernetes cluster**.

* Deploy a multi-service application on a **Kubernetes cluster** in **Microsoft Azure**.


# Submission {-}


* In order to submit your work, you need to answer all the questions 
that you **[find here](https://centralesupelec.edunao.com/mod/quiz/view.php?id=151760){target=_blank}**.

* **Only one member** of the group must fill in the questionnaire.

* You can answer the open questions either in French or in English.

* Some questions require you to upload files. 

* You can pause the test at any moment. Your answers will be stored; you'll find them when you resume the test.

* After answering the last question, you need to click on the button *Terminer le test* (*Finish attempt* if you use the interface in English) to submit the questionnaire.
**The submission is final. After submitting, you cannot change your answers anymore.**

* **Deadline: 23 May 2024, 23h59**



# Context {-}

We intend to build and deploy a Web application called *TripMeal* that let users share their favorite recipes.
You can download the application 
[here](/courses/cloud-computing/kube-lab/tripmeal.zip).
The source code has been readapted from 
[this GitHub repository](https://github.com/DanielAndreasen/TripMeal){target="_blank"}.


The downloaded file is an archive. 
Extracting the archive will create a folder named 
``tripmeal_sujet``.

# Bulding and deploying with Docker Compose


You're going to build and deploy the application using Docker Compose. 
In the folder ``tripmeal_sujet`` you should see a file named *docker-compose.yml*.


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-1"><strong>(\#exr:unnamed-chunk-1) </strong></span>
Answer on Edunao. What is the file *docker-compose.yml* used for?
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

The folder contains:

* A file ``docker-compose.yml`` that will contain the instructions
to build and deploy the application.

* A subdirectory for each service composing the application. Each subdirectory 
contains the source code of the corresponding service, as well as a Dockerfile
with the instructions to build an image for the service.

:::

</details>


Look at the files and folders inside the folder ``tripmeal_sujet``.


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-2"><strong>(\#exr:unnamed-chunk-2) </strong></span>
Answer on Edunao. How many services does the application *TripMeal* have?
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

The application consists of two services:

- web: It is a web application, developed with a combination of HTML, 
Python and Flask

- db: It is a relational database. From the Dockerfile, which is already given,
we understand that the DBMS used is MySQL.

:::

</details>


The ``Dockerfile`` in the directory ``db`` is already implemented. 
Open it and read the content to answer the following  questions.

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-3"><strong>(\#exr:unnamed-chunk-3) </strong></span>
Answer on Edunao. Which DataBase Management System (DBMS) is used in the *TripMeal* application?
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

MySQL. You can see it from the Dockerfile of the db service.

:::

</details>

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-4"><strong>(\#exr:unnamed-chunk-4) </strong></span>
Answer on Edunao. What is the version (tag) of the image used for the database management system of *TripMeal*? 
Find the documentation of the image and use it to answer this question.
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

The documentation is available at [here](https://hub.docker.com/_/mysql){target="_blank"}. 
Since no tag is specified in the Dockerfile, the latest version is selected.

:::

</details>


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-5"><strong>(\#exr:unnamed-chunk-5) </strong></span>
Where does Docker get the base image for the database management system from?
</div>\EndKnitrBlock{exercise}

:::


<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

From the Docker official registry. In fact, in the Dockerfile we only give  the name of the image and we don't specify
any reference to another registry. Therefore, by default, Docker looks into its own registry.

Of course, if the image is already available locally, Docker does not look for it in the registry.

:::

</details>



## Dockerfile in folder ``web``

If you open folder ``web``, you'll see that the Dockerfile is empty.


::: {.infobox .activitybox data-latex="{exercisebox}"}
**Activity**

Complete the ``Dockerfile`` in the directory ``web``.

* You need a Python 3.7 environment to run the application.

* The application consists of several files and folders. You need to include all of them into a Docker image.

* Add the following instruction in your Dockerfile:

``
RUN chmod -x path_to_file_app
``

where ``path_to_file_app`` is the path to the file ``app.py`` **inside the image**.
This will prevent an ``Exec format error`` from occurring.


:::


Time to make sure that we can build an image from this Dockerfile and we can run a container from that image.




::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-6"><strong>(\#exr:unnamed-chunk-6) </strong></span>

* Build an image from the Dockerfile that you've just completed using the ``docker build`` command. 
You can give the image any name you want. For simplicity, I assume that you call it ``web-test``.

* Run a container from this image by typing the following command. The command will only work if you type 
it from the  directory where the file ``tripmeal.env`` is stored. 


``
docker run --env-file tripmeal.env -p 3000:5000 web-test
``

* Open a Web browser and type the following URL: ``localhost:3000``. You should see the interface of the application. If that's not the case, stop the container, 
and correct the Dockerfile. 

* If you click on the links *New recipe*, *All recipes*, *Weekly menu* and *Login* in the application interface, you will get a connection error to the database server. 
This is normal and will be fixed later.


If the image passes the test, **upload the Dockerfile to Edunao.**


</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

Different solutions exist, here is a proposition.
It is important that we build a minimal image, so 
we choose the environment python:3-7-slim.

```
FROM python:3.7-slim
RUN mkdir -p /app & \
    mkdir -p /app/templates & \
    mkdir -p /app/static
RUN /usr/local/bin/python -m pip install --upgrade pip
COPY ./static /app/static/
COPY ./templates /app/templates/
COPY requirements.txt /app/
WORKDIR /app
RUN pip install -r requirements.txt
COPY app.py dbconnect.py /app/
ENTRYPOINT ["python","app.py"]
```

:::

</details>


## The environment variables

When testing the image of the service ``web``, you may have noticed that we passed the file ``tripmeal.env`` as an argument to the command ``docker run``.
This file contains the definition of **environment variables** that are used in the application. 
Open this file and look at the environment variables to answer the following questions.


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-7"><strong>(\#exr:unnamed-chunk-7) </strong></span>
Answer on Edunao. What does the environment variable SERVER_PORT refer to? 

</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

SERVER_PORT refers to the port where the the web application will be waiting for incoming requests.

:::

</details>



::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-8"><strong>(\#exr:unnamed-chunk-8) </strong></span>
Answer on Edunao. Which of the following sentences are true?

a. When you execute TripMeal, SERVER_PORT will be opened on the network interface of the host computer (your computer).

b. When you execute TripMeal, SERVER_PORT will be opened on the network interface of a container.

c. In order to access the Web interface of TripMeal, you'll need to map SERVER_PORT to a port number p; p will be opened on the network interface of the host computer (your computer).

d. When you execute TripMeal, you'll be able to access the Web interface by typing the URL localhost:$SERVER_PORT in your browser.

</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

b. and c. are true.


:::

</details>


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-9"><strong>(\#exr:unnamed-chunk-9) </strong></span>
Answer on Edunao. 
When you write the file ``docker-compose.yml``, you'll need to give the database service a name. 
Which of the environment variables tells you the name that you must use?

</div>\EndKnitrBlock{exercise}

:::


<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

The variable that tells us the name of the database service is DATABASE_HOST. 
The web service connects to the database that is found at DATABASE_HOST.
In our case, the host is a container. Evidently, Docker Compose uses the 
name of the service as the host name for the container.


:::

</details>


## Volumes and networks

The *TripMeal* application keeps user information and recipe information in a database.
Therefore, you'll need to define a Docker **volume** to hold the data.

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-10"><strong>(\#exr:unnamed-chunk-10) </strong></span>
Answer on Edunao. Look at the documentation of the base image of the database management system of the application.
Which directory inside the database image will you attach the volume to?
</div>\EndKnitrBlock{exercise}

:::



<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

Looking at the documentation of the MySQL image, the path is 
/var/lib/mysql. 


:::

</details>


The containers composing the *TripMeal* application need to communicate through a Docker **network**.



::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-11"><strong>(\#exr:unnamed-chunk-11) </strong></span>
Answer on Edunao. If you don't explicitly create any network, the containers will be able to communicate anyway. 
How do you explain it? 


**Note.** You can answer this question after writing the Docker compose file and running the application.
</div>\EndKnitrBlock{exercise}

:::



<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

By default, containers that are not explicitly connected to a network are automatically connected 
to the network called bridge, which is the default network in Docker.
Therefore, the services of the application TripMeal can communicate through this network.


:::

</details>


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-12"><strong>(\#exr:unnamed-chunk-12) </strong></span>
Answer on Edunao. Why is not creating a network for the application considered a bad idea, 
even if the application works?

</div>\EndKnitrBlock{exercise}

:::



<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

All containers created on the host machine will be connected to a single network.
As a result, all containers can communicate. 
If only one container is compromised, the attacker will have a shot at compromising 
all of them. 


:::

</details>





## The compose file


You're finally ready to complete the file ``docker-compose.yml``. 


::: {.infobox .activitybox data-latex="{exercisebox}"}
**Activity**

Write the file ``docker-compose.yml``. 

* Remember that you need to pass the **environment variables** 
to your application. 

* As a documentation of Docker Compose you can use:

    * The [examples that we've seen together](/courses/cloud-computing/tutorials/tutorial-kube){target="_blank"}.

    * The overview presented on the [official Docker website](https://docs.docker.com/compose/){target="_blank"}.

    * You can also find the full specification of Compose [here](https://github.com/compose-spec/compose-spec/blob/master/spec.md){target="_blank"}.


* Run the application and test it. You should be able to see the Web interface of the application, create an account, share a recipe and 
look at the list of shared recipes.


* If you experience problems, you might find the command ``docker-compose logs`` useful.

:::


<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

```
version: "3"

services:
    web:
        build: web
        image: quercinigia/trip-meal-web
        env_file: tripmeal.env
        networks:
            - tripmeal-network
        ports:
            - "5000:5000"
    db: 
        build: database  
        image: quercinigia/trip-meal-db
        env_file: tripmeal.env
        networks:
            - tripmeal-network
        volumes:
            - db-data:/var/lib/mysql

volumes:
    db-data:

networks:
    tripmeal-network:
```

:::

</details>


If you successfully deployed the application, you can continue.

::: {.infobox .warning data-latex="{warning}"}
**Shut down the application!**

Shut down both the application before you move on.

:::



::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-13"><strong>(\#exr:unnamed-chunk-13) </strong></span>
Upload your file ``docker-compose.yml`` to Edunao.

</div>\EndKnitrBlock{exercise}

:::


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-14"><strong>(\#exr:unnamed-chunk-14) </strong></span>
<u>Use Docker Compose</u> to push all the images that you built in this section to 
your DockerHub registry.

**In the answer to this exercise write the link to the uploaded images.**

</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

We can use DockerCompose to push the images. 
The command is: 

```
docker-compose push
```

:::

</details>



# Local Kubernetes cluster

We intend to deploy the application *TripMeal* on 
a **local Kubernetes cluster** (either Docker Desktop or Minikube).



::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-15"><strong>(\#exr:unnamed-chunk-15) </strong></span>
Answer on Edunao. For each service of the application *TripMeal*, specify 
the Kubernetes objects that you need to create and their types.
Justify your answers.
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

For the service ``web`` we need two objects:

* A **deployment**, which is collection of identical pods, each pod being an instance 
of the service. Deployments are often used for stateless services, which is the case of the 
``web`` service.

* A **LoadBalancer service**. We need it in order to expose the service so that a client can connect to it.

For the service ``db`` we need two objects:

* A **StatefulSet**, which is a sort of Deployment used for stateful services.

* A **ClusterIP service**, used to expose the service internally in the Kubernetes cluster.
The database is only used the by service  ``web``, 
it doesn't need to be accessed from external clients.

:::

</details>

::: {.infobox .warning data-latex="{warning}"}
**Help**

In order to write the specification of each object, you can refer to the 
examples that we discussed together in the second tutorial.
You can also refer 
to the [API documentation on the Kubernetes website](https://kubernetes.io/docs/reference/kubernetes-api/){target="_blank"}.

:::






::: {.infobox .activitybox data-latex="{exercisebox}"}
**Activity**



For each Kubernetes object:

1. **Configure.** Write a Yaml configuration file. Remember that you need to pass the environment variables to the application.

2. **Create.** Create the object in Kubernetes with ``kubectl``.

3. **Analyze.** Execute the command ``kubectl get all`` to confirm that all components run as intended.

4. **Test.** Play with the application to confirm that is works as intended.

**In case of problems.**

You can look at the logs of a pod with the following command: ``kubectl logs NAME-OF-POD --previous``




:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

The configuration of the Deployment associated to the ``web`` service is 
as follows:

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tripmeal
      service: web
  template:
    metadata:
      labels:
        app: tripmeal
        service: web
    spec:
      containers:
      - image: quercinigia/trip-meal-web:latest
        name: web
        ports:
        - containerPort: 5000
          protocol: TCP
        env:
        - name: DATABASE_NAME
          value: "tripmealdb"
        - name: DATABASE_USER
          value: "root"
        - name: MYSQL_ROOT_PASSWORD
          value: "my-secret-pw"
        - name: DATABASE_HOST
          value: "db"
        - name: DATABASE_PORT
          value: "3306"
        - name: TRIPMEAL_KEY
          value: "my-secret-key"
        - name: SERVER_PORT
          value: "5000"
```

When we create the deployment with  the command:

``
kubectl create -f web-deployment.yml
``

three objects are created in Kubernetes:

* A pod, that represents an instance of the service. Here we specified only one replica, hence we have only one pod.

* A Deployment, the object that we demanded.

* A ReplicaSet, the object that controls the collection of pods that are the instances of the service.
The ReplicaSet is managed by the Deployment.

The configuration of the LoadBalancer service associated with the ``web`` service is as follows:

```
apiVersion: v1
kind: Service
metadata:
  name: web
spec:
  type: LoadBalancer
  ports:
  - port: 5000
    targetPort: 5000
    protocol: TCP
  selector:
    app: tripmeal
    service: web
```

When we create the service with the following command:

``
kubectl create -f web-service.yml 
``

A service object is created. 
The type of this service is LoadBalancer. An external IP address is associated with the service.
It is through this IP address that we can connect to the service.

The configuration of the StatefulSet associated to the service ``db`` is as follows:

```
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: db
spec:
  selector:
    matchLabels:
      app: tripmeal
      service: db
  serviceName: db
  template:
    metadata:
      labels:
        app: tripmeal
        service: db
    spec:
      containers:
      - image: quercinigia/trip-meal-db:latest
        name: db
        ports:
        - containerPort: 3306
        volumeMounts:
        - mountPath: /var/lib/mysql
          name: tripmeal-data
        env:
        - name: DATABASE_NAME
          value: "tripmealdb"
        - name: DATABASE_USER
          value: "root" 
        - name: MYSQL_ROOT_PASSWORD
          value: "my-secret-pw"
  volumeClaimTemplates:
  - metadata:
      name: tripmeal-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Mi
```



When we create the object with the command:

``
kubectl create -f db-stateful-set.yml
``

two objects are created:

* A pod, that represents one instance of the service.

* A StatefulSet, that manages the pod.

Finally, the configuration of the ClusterIP service associated with the ``db`` service
is as follows:

```
apiVersion: v1
kind: Service
metadata:
  name: db
spec:
  type: ClusterIP
  ports:
  - port: 3306
    protocol: TCP
  selector:
    app: tripmeal
    service: db
```

When we create the object with the following command:


``
kubectl create -f db-service.yml
``

A new service appears in the output. The service has no external IP, which is normal 
given that it is only available internally. Its cluster IP address is used 
by the service ``web`` to connect to the database.

:::

</details>




::: {.infobox .warning data-latex="{warning}"}
**Shut down the application!**

Shut down the application by removing all the Kubernetes objects.

:::


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-16"><strong>(\#exr:unnamed-chunk-16) </strong></span>
Create a new file called ``tripmeal.yml`` that contains the 
definition of all the Kubernetes objects of the application, as we have seen 
in the [conclusion of the tutorial 2](/courses/cloud-computing/tutorials/tutorial-kube#conclusion){target="_blank"}.

**Upload this file to Edunao.** 
</div>\EndKnitrBlock{exercise}

:::



# Kubernetes cluster on Microsoft Azure

At this point you should have successfully deployed the application on your local Kubernetes cluster.

You're now going to create a Kubernetes cluster on **Microsoft Azure** 
and deploy *TripMeal* on that cluster.

::: {.infobox .warning data-latex="{warning}"}
**Warning**

If you haven't activated it yet:

* Connect to [this webpage](https://azure.microsoft.com/en-us/free/students/){target="_blank"}.

* Click on ``Start free``.

* Sign in by using your CentraleSupélec credentials.

* Follow the instructions.


:::

During this activity, you'll need to answer some questions that encourage you to 
gain a deeper knowledge of the Azure platform and better understand the commands that you type.
**Feel free to read the documentation on the Azure platform in order to answer the questions.**

## Login to Azure through CLI

::: {.infobox .warning data-latex="{warning}"}
**Warning**

If you get the message *command not found* when you type ``az``, it means that you haven't installed 
the Azure CLI yet. 
You'll find more information on the [Edunao course page](https://centralesupelec.edunao.com/course/view.php?id=8081#section-4){target="_blank"}.

Make sure you run version 2.25 or higher of the Azure CLI, by typing:

``
az --version
``

**If you use a VM with Multipass you'll need to install the Azure CLI with the following command:**

``
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
``

**If you use a VM either with Multipass or with VirtualBox you'll need to re-install kubectl:**

* Type the following command so as the command ``kubectl`` does not refer to ``minikube kubectl`` anymore:

``
unalias kubectl
``

* Type the following command to install a new version of ``kubectl``:

``
sudo az aks install-cli
``


:::

Whether you're on Windows, macOS or Linux, you need to **open a terminal**.

In order  to log in to your Azure account, type the following command:

``
az login
``

A Web page will open in your default Web browser, where you can type your username and 
password (your CentraleSupélec credentials).
After authenticating your Azure account, you can go back to the terminal, where you should see
some information about your account, such as:

```
[
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "<id>",
    "id": "<id>",
    "isDefault": true,
    "managedByTenants": [],
    "name": "Azure for Students",
    "state": "Enabled",
    "tenantId": "<id>",
    "user": {
      "name": "<email-address>",
      "type": "user"
    }
  }
]
```

## Deploy and use Azure Container Registry

When we run TripMeal on a local Kubernetes cluster, we assumed that our computer
could have a direct access to the Internet and, therefore, to the DockerHub registry, where we 
could pull the images of the TripMeal services.
When we run a containerized application in production, we cannot make this assumption 
as the production servers have often no direct access to the Internet.


We need to place the images in a container registry that is in the same context 
as our production servers. 
Since we're going to run the application on Azure, we can use the 
**Azure Container Registry (ACR)**.

### Registry creation

First, we need to create a **resource group**.

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-17"><strong>(\#exr:unnamed-chunk-17) </strong></span>
Answer on Edunao. What is a **resource group** in Azure and how is it useful?
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

It is a logical container of resources that are managed together,
typically because they belong to the same application.
Resource groups are useful to manage with a single click 
the whole set of resources (e.g., the permissions). 
For instance, when we want to decommission the application, we can remove 
all the resources with just one command/one click.


:::

</details>


The command to create a new resource group is the following
(replace RES_GRP_NAME with a name of your choice).

``
az group create --name  RES_GRP_NAME --location francecentral
``

::: {.infobox .warning data-latex="{warning}"}
**Warning**

If ``francecentral`` does not work for your account, the previous command will normally suggest a possible location.
Choose one that is near you.

:::

You can verify that the resources are correctly created by looking [in the Azure portal](https://portal.azure.com/){target="_blank"}.

Next, we need to create a **container registry** with the following command
(replace RES_GRP_NAME with the name of your resource group and REG_NAME with a name of your choice for the registry).


``
az acr create --resource-group RES_GRP_NAME --name REG_NAME --sku Basic
``

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-18"><strong>(\#exr:unnamed-chunk-18) </strong></span>
In the previous command, what does ``sku`` refer to?
Feel free to look up on the Azure website to find the answer.
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

SKU stands for *Stock Keeping Unit*, it represents the different service levels of a product.
Here we use a registry container with a *Basic* service level.

:::

</details>


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-19"><strong>(\#exr:unnamed-chunk-19) </strong></span>
Answer on Edunao. Based on the specified ``sku``, find on the Internet how much the container registry will cost (in euros) per day if 
the container registry is instantiated in the region ``France Central``.
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

Each sku is associated with a price. Here students need to do some searching.
If you look [at this webpage](https://azure.microsoft.com/en-us/pricing/details/container-registry/){target="_blank"}
we find the price of a basic container registry and the included storage.
The idea here is to make students aware of the fact that the options that we select have a cost.


:::

</details>



### Registry login

After creating the registry, we can log into it with the following command:

``
az acr login --name REG_NAME
``

### Image tagging

We're almost ready to push the images that compose the application *TripMeal* to the registry.
In order to do that, we need to **tag** (i.e., rename) our images so that their names are 
preceded by the **login server name** of the registry.

In order to get the name of the **login server name** 
(that we denote here as ``acrloginserver``) of your registry, you can type 
the following command:

``
az acr list --resource-group RES_GRP_NAME --query "[].{acrLoginServer:loginServer}" --output table
``

Your ``acrloginserver`` will be something like ``xxx.azurecr.io``.

::: {.infobox .activitybox data-latex="{exercisebox}"}
**Activity**


Tag the images that correspond to the services of the  application *TripMeal* so that
their name is similar to: ``acrloginserver/nameofimage:latest``. You can use the 
command ``docker tag``.


:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

We can use the ``docker tag`` function.
For instance, in my case I use the following two commands 
to rename my two images:

``
docker tag quercinigia/trip-meal-web:latest tripmealacr.azurecr.io/trip-meal-web:latest
``

``
docker tag quercinigia/trip-meal-db:latest tripmealacr.azurecr.io/trip-meal-db:latest
``



:::

</details>

### Pushing the images

We can push the images with the following command (use your image name 
instead of ``xxx.azurecr.io/imagename:latest``).

``
docker push xxx.azurecr.io/imagename:latest
``

Make sure to **type this command for each image** that you want to push.

::: {.infobox .warning data-latex="{warning}"}
**Warning**

It might take few minutes before the images are completely pushed to the registry.

:::

Finally, verify that the images are actually in the registry with the following command:

``
az acr repository list --name REG_NAME --output table
``

Alternatively, you can connect to [your Azure portal](https://portal.azure.com/){target="_blank"}
and visually browse your resources. 

## Deploy a Kubernetes cluster

We now deploy a **Kubernetes cluster on Azure**.

### Cluster creation

We create the cluster with the following command (replace CLUSTER_NAME 
with a name of your choice. As before, RES_GRP_NAME is the name of your resource group 
and REG_NAME is the name of the container registry).


```bash
az aks create \
    --resource-group RES_GRP_NAME \
    --name CLUSTER_NAME \
    --node-count 2 \
    --generate-ssh-keys \
    --attach-acr REG_NAME
```

::: {.infobox .warning data-latex="{warning}"}
**Warning**

If you get an error on your SSH key, then your key is not in the right format. 

Here is how we suggest you to proceed.

1. Open your home directory in Visual Studio.

2. Locate the hidden folder  ``.ssh``.

3. You should have a file named ``id_rsa.pub`` under folder ``.ssh``.  Open it.

4. Copy the whole content of the file.

5. Create a new file under folder ``.ssh``. Give it a name of your choice (for instance, ``id_kube_rsa.pub``).

6. Paste the content into the new file, while making sure that you don't have any whitespace before 
the first character.

7. Save and close the file.

8. Type the command ``az aks create`` and replace the ``--generate--ssh-keys`` option with ``--ssh-key-value ~/.ssh/id_kube_rsa.pub``.






:::

The cluster will take a while to start. Time for a coffee!
But before, answer the following question!

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-21"><strong>(\#exr:unnamed-chunk-21) </strong></span>
What is the meaning of the option ``node-count`` in the previous command?
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}



The number of nodes in the Kubernetes cluster. Here we specify 2.
Note that this refers to the number of worker nodes.
In fact, the control plane is managed by Azure. 
It is still possible though to create a custom advanced configuration to control 
the number of master and etcd nodes.



:::

</details>

### Connect to the cluster

We can configure ``kubectl`` to connect to the newly created cluster.
You need to type the following command:

``
az aks get-credentials --resource-group RES_GRP_NAME --name CLUSTER_NAME
``

Now, your Kubernetes cluster should be visible locally.
To verify it, type the following command:

``
kubectl config get-contexts
``

Here *context* refers to the Kubernetes clusters that *kubectl* has access to.
The Kubernetes cluster that you created on Azure should be visible in the output; an asterisk
should appear in front of its name, indicating that it is the *current context* 
(that is the Kubernetes cluster being currently referenced by ``kubectl``).

Type the following command:

``
kubectl get nodes
``

You should see the information about the nodes in the cluster.

## Deploy the application 

We're almost done! The images are in the registry, the Kubernetes cluster is up and running.
The only missing piece of the puzzle is our application *TripMeal*.

First thing to do is to slightly modify the file ``tripmeal.yml`` that you created at the end
of the previous section.

::: {.infobox .activitybox data-latex="{exercisebox}"}
**Activity**

Look at the names of the images of each service in that file. How must these names change?
Modify the file accordingly (**no need to upload it on Edunao**).



:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}


The existing names refer to the images on the DockerHub registry.
We must change them so that they refer to the images on our Azure container registry.

:::

</details>

It is the moment you've been waiting for! 
Deploy your application by typing the following command:

``
kubectl apply -f tripmeal.yml
``

Look at Kubernetes objects created after this command:

``
kubectl get all
``

Wait for all the components to be up and running. 
Get the external IP address of the web service and try to connect to the application,
in the same way you did in the previous section.

**If you can play with the application like you did in your local deployment it means that you reached 
the conclusion of this assignment! Bravo!**

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-22"><strong>(\#exr:unnamed-chunk-22) </strong></span>
Submit a **video** like that the one that [**you can see here**](https://webtv.centralesupelec.fr/permalink/v1261a00b74dbbzwk2vr/){target="_blank"}.

The video must **clearly** show that:

* You're connected to **your Azure portal** (Email address on the top right corner of the portal).

* All the passages that you see in the sample video: you need to show the **public IP address**
of the application that you deployed, use that address to connect to your application and play 
with the application to show that it works correctly.

</div>\EndKnitrBlock{exercise}
:::

The next exercise is **optional**.

If you don't intend to do it, **make sure to read the conclusion of this document to take down the application and remove all resources!!**.


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-23"><strong>(\#exr:unnamed-chunk-23) </strong></span>
The title of this exercise is *Cerise sur le gâteau* (i.e., this is **optional**!).

At this point, you can connect to *TripMeal* by using an IP address. 
It would be nice if you could use a URL, like in the real websites.
Can you find a way to assign a URL to your web service? **Describe your procedure.**

You need a bit of Googling here....
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

We have to modify the definition of the web service in the file ``tripmeal.yml``
More precisely, here is the new definition:

```
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.beta.kubernetes.io/azure-dns-label-name: mytripmeal
  name: web
spec:
  type: LoadBalancer
  ports:
  - port: 5000
    targetPort: 5000
    protocol: TCP
  selector:
    app: tripmeal
    service: web
```

We added the field ``metadata.annotations`` and specify a DNS label.
Then we need to restart the service.
If everything goes well, the application is reachable at the following address:

``
http://mytripmeal.francecentral.cloudapp.azure.com:5000/
``

The URL is composed by the DNS label that we specified + the region where we deployed the cluster +
cloudapp.azure.com



:::

</details>

# Conclusion {-}

Make sure you follow these instructions:

* Take down your application in Kubernetes by using the following command:

``
kubectl delete -f tripmeal.yml
`` 

* Change the context of the ``kubectl`` command so that it points back 
to a local Kubernetes cluster. Type the following command, where 
CONTEXT_NAME will be ``docker-desktop`` or ``minikube``, depending on which local Kubernetes cluster 
you use.

``
kubectl config use-context CONTEXT_NAME
``

* **Destroy all the resources** linked to the application
*TripMeal* on Microsoft Azure, otherwise you'll get billed even if you don't use them!
You can destroy all the resources by simply deleting the resource group to which they belong.
You can do it through the Azure portal or by typing the following command (replace RES_GRP_NAME with the name
of the resource group that you intend to remove).

``
az group delete --name RES_GRP_NAME
``

* You can check the balance of your Azure credit [here](https://www.microsoftazuresponsorships.com/Balance){target="_blank"}.

* You can stop Docker and Kubernetes if you don't need it anymore. 

<!-- https://stackoverflow.com/questions/55271912/flask-cli-throws-oserror-errno-8-exec-format-error-when-run-through-docker-->
<!-- merge 1.2 with 1.3, so that we can ask students to point out exactly the common layers -->
<!-- # Docker networking model

We developed a simple chat room in Python that you can download 
[here](/courses/cloud-computing/kube-lab/chat-room.zip). 
The code has been adapted from [this GitHub project](https://github.com/pricheal/python-client-server/){target="_blank"}.

Participants use a *client* program to connect to the chat room;
the chat room is managed by a *server* application  that receives the 
client connections and forwards the messages between the users.
The archive contains the following files:

* *client.py*. Implementation of the chat room client.
* *server.py*. Implementation of the chat room server.
* *utils.py*. Library with utility functions used in both *client.py* and *server.py*.

The application is written in Python and it **requires Python 3.7**. 
The application doesn't need any third-party library, the packages included in a minimal Python environment are enough.




::: {.infobox .exercisebox  data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:client-server-methodology"><strong>(\#exr:client-server-methodology) </strong></span> 

a. Is a single Docker image for this application enough? Justify your answer.

b. Given your answer to the previous question, how many Docker images do you need to create? 
</div>\EndKnitrBlock{exercise}


:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

a. One image is not enough, because the client and the server are two separate processes.

2. We need to create two images, one for the client and one for the server.

:::

</details>

We now build the images for the application.

:::{.infobox .curiosity data-latex="curiosity"}
**Good to know**

If you need to inspect the file system of an
image that you create (e.g., to verify that the files that you 
copied are actually there), you can open a terminal 
in the image by using the following command:

``
docker run -it --entrypoint sh IMAGE_NAME
``

:::


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-24"><strong>(\#exr:unnamed-chunk-24) </strong></span>Build the image(s) for the application. For each image:

a. Upload the Dockerfile to Edunao.
b. Write the **exact** command that you used to build the image.
</div>\EndKnitrBlock{exercise}

::: {.infobox .warning data-latex="{warning}"}
**Warning**

The size of the images should be kept as small as possible.
Remember to include in the images only what you need to build and run the application.

:::

If you built more than one image:

c. Do they have some common layers? Which ones?

d. If so, is it something that has an impact on the build time and how?

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

For both the client and the server we need a Python environment. 
We use the Python environment *slim* as a base image to minimize the size of the image. 
Students who choose this base image are rewarded. 
If they choose another (bigger) Python environment, that is fine, but they don't get 
the totality of the points.
If they use an OS as a base image (e.g., ubuntu), they get penalized.

The Dockerfile for the client (let's call it *Dockerfile-client*)
is as follows.

```dockerfile
FROM python:3.7-slim
RUN mkdir -p /app
WORKDIR /app
COPY ./client.py ./utils.py /app/
ENTRYPOINT ["python", "client.py"]
```

We build the image with the following command:

``
docker build -t chat-client -f Dockerfile-client .
``

The Dockerfile for the server (let's call it *Dockerfile-server*) 
is as follows.

```dockerfile
FROM python:3.7-slim
RUN mkdir -p /app
WORKDIR /app
COPY ./server.py ./utils.py /app/
ENTRYPOINT ["python", "server.py"]
```

We build the image with the following command:

``
docker build -t chat-server -f Dockerfile-server .
``

c. The base image is the same for both images. The layers 2 and 3 are identical

d. Assuming that we build the client first, this build will take longer if
the python-slim image has not been downloaded yet from the registry.
Layers 2 and 3 already exist when the server is built.
This is indicated by the phrase "Using cache" when we build the server.
It is important that here the students talk about the build cache mechanism.


:::

</details>






## Client and server on the same network

We want to execute:

* One instance of the server.

* Two instances of the client.

The server, as well as the clients, will 
**run in Docker containers attached to the same network**.


::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-25"><strong>(\#exr:unnamed-chunk-25) </strong></span>
We want to make sure that:

1. The server and the clients can communicate with each other.

2. Other Docker containers **cannot** communicate neither with the server nor with the clients.  

How can you satisfy both requirements in Docker? Explain your solution 
and justify it.
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

If we create the three containers without specifying any network configuration, then
the three containers will be attached to the default ``bridge`` network.
This way, we can satisfy the first requirement, but not the second (other containers attached
to ``bridge`` will be able to communicate with the clients and the server).

We need to create a new network in Docker, let's call it ``chat-room`` that 
will be used exclusively for the server and the two clients.

:::

</details>

::: {.infobox .warning data-latex="{warning}"}
**Warning**

Only one instance of the server is running. 
Two instances of the client run at the same time.

1. In order to execute the server, we need to **pass a port number as a parameter**. Choose one in the range [49152–65535].

2. In order to execute the client, we need to **pass as parameters the IP address of the server and the port** which the server listens to (the one that you specified at 1.).

:::




::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**

\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:client-server-single-network"><strong>(\#exr:client-server-single-network) </strong></span>
Execute the server and the two clients by using the network configuration that you
explained in the previous exercise.

* The server writes messages on the terminal. Remember to launch the container with the appropriate 
options in order to actually see those messages.

* Users need to interact with the client, that is: read and write messages. 
Remember to launch the container with the appropriate options in order to actually see those messages.

Write the **exact commands** that you typed for 
both configuring the network and launching the server and the clients.  **Explain these commands.**
</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

First, we create the new network ``chat-room`` by typing the following command:

``
docker network create chat-room
``

Next, we launch the server with the following command:

``
docker container run --rm -t --name chat-server --network chat-room chat-server 60876
``

The server takes in a port number as a parameter.
If the students launch the server without specifying it, they'll get an error message
that should lead them to understand what's missing.

In another terminal, we type the following command to run the first client:

``
docker container run --rm -it --name chat-client1 --network chat-room  chat-client chat-server 60876
``

Note that we attach the client to the same network as the server. 
When we launch the client, we need to pass as parameters the server host (here we can use the 
container's name ``chat-server`` of the server or its IP address) and the port number 
(same as we specified when we launched the server).
When we launch the client, we'll need to specify a username and then we can start typing messages in the chat room.

Finally, we open another terminal to launch the second client with the following command:

``
docker container run --rm -it --name chat-client2 --network chat-room  chat-client chat-server 60876
``

The only thing that changes wrt the previous command is the name that we give the new container 
(``chat-client2``).

We can play with the chat to verify that the clients can exchange messages.

:::

</details>

::: {.infobox .warning data-latex="{warning}"}
**Shut the application down!**

Shut both the clients and the server down  before you move on.

* On the client-side, type ``#quit`` at any moment to exit the chat room.

* Type Ctrl-C to stop the server.

:::


## Client and server on different networks

We want to execute:

* One instance of the server.

* Two instances of the client.

However, **neither client** is connected to the same network as the server.

::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-26"><strong>(\#exr:unnamed-chunk-26) </strong></span>
Why can't you launch the containers with the same settings as 
in Exercise \@ref(exr:client-server-single-network)?

What do you propose as a solution instead?

</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

The hostname ``chat-server`` is not reachable from the clients, because they're not in the 
same network as the server. 
So, the only way out is to use the mechanism of port mapping.
That is: we launch the server on the container port 60876
but we also use the option ``-p`` to map that port to any available port
(say, 7070) on the **host computer**.
This way, the clients can connect to the server by specifying the IP address
of the host machine and 7070 as the port number.

:::

</details>




::: {.infobox .exercisebox data-latex="{exercisebox}"}
**Exercise**


\BeginKnitrBlock{exercise}<div class="exercise"><span class="exercise" id="exr:unnamed-chunk-27"><strong>(\#exr:unnamed-chunk-27) </strong></span>
Execute the server and the two clients by making sure that neither client is connected to the 
same network as the server.

Write the **exact commands** that you typed 
for both configuring the network and launching the server and the clients.
**Explain these commands.**

</div>\EndKnitrBlock{exercise}

:::

<details>
<summary>Solution</summary>

::: {.infobox .exosolution data-latex="{exercisebox}"}

As before, we can still connect the server to the network 
``chat-room``.
However, since we want our server to be reachable from outside that network,
we need to publish a port on the host. 
The option ``-p`` in the following command maps the container 
internal port 60876 to the port 7070 on the host computer.

``
docker container run --rm -it --name chat-server --network chat-room -p 7070:60876 chat-server 60876
``

Now, let's create a new network that we call ``net-clients`` 
to which we'll be attaching the two clients:

``
docker network create net-clients
``

And we finally launch the two clients. As host of the server, 
we need to type the IP address assigned to the host.
In my case, the IP address assigned to my host is 192.168.1.8

``
docker container run --rm -it --name chat-client1 --network net-clients chat-client  192.168.1.8 7070
``

The second client is launched as follows:

``
docker container run --rm -it --name chat-client2 --network net-clients chat-client  192.168.1.8 7070
``


:::

</details>

::: {.infobox .warning data-latex="{warning}"}
**Shut the application down!**

Shut both the clients and the server down before you move on.

* On the client-side, type ``#quit`` at any moment to exit the chat room.

* Type Ctrl-C to stop the server.

::: -->
<p>–&gt;</p>

          </div>

          



          
        </div>

        
      </article>

      

    </main>
  </div>
</div>


      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = false;</script>
    

    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
    
    
    
    <script src="/js/academic.min.3da86581634ab22d5bb3fc4505df30a5.js"></script>

    






  
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
